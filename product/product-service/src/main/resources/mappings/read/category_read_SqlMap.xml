<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.egeo.components.product.dao.read.CategoryReadDAO">
	<resultMap type="com.egeo.components.product.po.CategoryPO" id="categoryMap">
		<result property="id" column="id" />
		<result property="serialNumber" column="serial_number" />
		<result property="name" column="name" />
		<result property="categoryLable" column="category_lable" />
		<result property="description" column="description" />
		<result property="platformId" column="platform_id" />
		<result property="createTime" column="create_time" />
		<result property="updateTime" column="update_time" />
		<result property="categoryBannerId" column="category_banner_id" />
	</resultMap>

	<resultMap type="com.egeo.components.product.condition.CategoryCondition" id="categoryCondition" extends="categoryMap">
		<result property="parentId" column="parent_id" />
		<result property="categoryCnt" column="category_cnt" />
		<result property="categoryTreeNodeId" column="category_tree_node_id" />
	</resultMap>
	<resultMap type="com.egeo.components.product.condition.CategoryAndJdCondition" id="categoryAndJdCondition" extends="categoryMap">
		<result property="jdName" column="jd_name" />
		<result property="jdCategory" column="jd_category" />
	</resultMap>
	<resultMap type="com.egeo.components.product.condition.CategoryAndChannelCondition" id="categoryAndChannelCondition" extends="categoryMap">
		<result property="channelCategory" column="channel_category" />
		<result property="channelCode" column="channel_code" />
		<result property="channelCategoryName" column="channel_category_name" />
		<result property="channelCategoryId" column="channel_category_id" />
		<result property="channelCategoryLevel" column="channel_category_level" />
		<result property="channelCategoryType" column="channel_category_type" />
		<result property="channelCategoryPId" column="channel_category_p_id" />
		<result property="remark" column="remark" />
	</resultMap>

	<sql id="categoryColumns">
		id,
		serial_number,
		name,
		category_lable,
		description,
		platform_id,
		create_time,
		update_time,
		category_banner_id
	</sql>

	<sql id="inClause">
		in
		<foreach collection="ids" item="id" open="(" separator=","
				 close=")">
			#{id}
		</foreach>
	</sql>
	<select id="findById" parameterType="com.egeo.components.product.po.CategoryPO" resultMap="categoryMap">
		SELECT
		<include refid="categoryColumns" />
		FROM category
		WHERE id = #{po.id}
	</select>

	<select id="findOfPage" resultMap="categoryMap">
		SELECT
		<include refid="categoryColumns" />
		FROM category
		<where>
			<if test="po.name != null">
				and name = #{po.name}
			</if>
			<if test="po.categoryLable != null">
				and category_lable = #{po.categoryLable}
			</if>
			<if test="po.description != null">
				and description = #{po.description}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY id desc
			</otherwise>
		</choose>
		<if test="page != null">
		limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>


	<select id="findCategoryByCategoryTreeNodes" resultMap="categoryAndJdCondition">
		SELECT
		jd.`name` AS jd_name,
		jd.`id` AS jd_category,
		t.`id`,
		t.`serial_number`,
		t.`name`,
		t.`category_lable`,
		t.`description`,
		t.`platform_id`,
		t.`create_time`,
		t.`update_time`,
		t.`category_banner_id`
		FROM category t
		LEFT JOIN jd_category jd ON t.`id`=jd.`inner_category_id`

		WHERE t.`id` IN (SELECT n.`category_id` FROM category_tree_node n
		<where>
			<if test="ids != null">
				 n.`id`
				<include refid="inClause" />
			</if>

		</where>
		);
	</select>
	<select id="countOfPage" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		FROM category
		<where>
			<if test="po.name != null">
				and name = #{po.name}
			</if>
			<if test="po.categoryLable != null">
				and category_lable = #{po.categoryLable}
			</if>
			<if test="po.description != null">
				and description = #{po.description}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
		</where>
	</select>

	<select id="findAll" resultMap="categoryMap">
		SELECT
		<include refid="categoryColumns" />
		FROM category
		<where>
			<if test="po.name != null">
				and name = #{po.name}
			</if>
			<if test="po.categoryLable != null">
				and category_lable = #{po.categoryLable}
			</if>
			<if test="po.description != null">
				and description = #{po.description}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY id desc
			</otherwise>
		</choose>
	</select>

	<select id="find" resultMap="categoryCondition">
		SELECT
		c.id,
		c.name,
		ctn.id category_tree_node_id,
		ctn.parent_id
		FROM category_tree_node ctn,category c
		<where>
			c.id = ctn.category_id and ctn.category_tree_id = 1
			<if test="po.name != null">
				and c.name = #{po.name}
			</if>
		</where>
	</select>

	<select id="findCategoryByPId" resultMap="categoryCondition">
		SELECT c.serial_number,(SELECT count(1) from category_tree_node WHERE parent_id = (SELECT id from category_tree_node WHERE category_id = c.id)) category_cnt from category c
		WHERE c.id = #{parentId}
	</select>

	<select id="findCategoryCntByPId" resultMap="categoryCondition">
		SELECT count(1) category_cnt from category_tree_node WHERE parent_id = #{parentId}
	</select>

	<select id="categoryByPIdNode" resultMap="categoryMap">
	SELECT
	c.id,
	c.serial_number,
	c.name,
	c.category_lable,
	c.description,
	c.platform_id,
	c.create_time,
	c.update_time
	FROM category_tree_node ctn
	LEFT JOIN category c on c.id = ctn.category_id
	WHERE ctn.id = #{parentId}
	</select>

	<select id="findCategoryNameBySuId" resultType="java.lang.String">
	SELECT c.`name` from category_tree_node_category ctnc
	LEFT JOIN category_tree_node ctn on ctn.id = ctnc.front_category_tree_node_id
	LEFT JOIN category c on ctn.category_id = c.id
	WHERE ctnc.queen_category_tree_node_id = #{suId}
	GROUP BY ctnc.queen_category_tree_node_id
	</select>

	<select id="findChannelCategoryByCategoryTreeNodes" resultMap="categoryAndChannelCondition">
		SELECT
			cc.`channel_category_name` AS channel_category_name,
			cc.`channel_category_id` AS channel_category_id,
			cc.`channel_category_level` AS channel_category_level,
			cc.`channel_category_type` AS channel_category_type,
			cc.`channel_code` AS channel_code,
			cc.`channel_category_p_id` AS channel_category_p_id,
			cc.`remark` AS remark,
			cc.`id` AS channel_category,
			t.`id`,
			t.`serial_number`,
			t.`name`,
			t.`category_lable`,
			t.`description`,
			t.`platform_id`,
			t.`create_time`,
			t.`update_time`,
			t.`category_banner_id`
		FROM category t
		LEFT JOIN channel_category cc ON t.`id`=cc.`inner_category_id` and cc.channel_code=#{channelCode}

		WHERE t.`id` IN (SELECT n.`category_id` FROM category_tree_node n
		<where>
			<if test="ids != null">
				n.`id`
				<include refid="inClause" />
			</if>

		</where>
		);
	</select>
</mapper>
