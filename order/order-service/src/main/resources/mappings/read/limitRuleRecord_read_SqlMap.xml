<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.egeo.components.order.dao.read.LimitRuleRecordReadDAO">
	<resultMap type="com.egeo.components.order.po.LimitRuleRecordPO" id="limitRuleRecordMap">
		<result property="id" column="id" />
		<result property="limitRuleId" column="limit_rule_id" />
		<result property="limitRuleName" column="limit_rule_name" />
		<result property="limitRuleSerialNumber" column="limit_rule_serial_number" />
		<result property="standardUnitSerialNumber" column="standard_unit_serial_number" />
		<result property="productUnitId" column="product_unit_id" />
		<result property="productUnitSerialNumber" column="product_unit_serial_number" />
		<result property="createUserid" column="create_userid" />
		<result property="createUsername" column="create_username" />
		<result property="createUserMobile" column="create_user_mobile" />
		<result property="orderCode" column="order_code" />
		<result property="buySum" column="buy_sum" />
		<result property="buyMoneySum" column="buy_money_sum" />
		<result property="createTime" column="create_time" />
		<result property="platformId" column="platform_id" />
		<result property="limitType" column="limit_type" />
		<result property="standardUnitId" column="standard_unit_id" />
		<result property="companyId" column="company_id" />
		<result property="storeId" column="store_id" />
		<result property="orderStatus" column="order_status" />

	</resultMap>

	<sql id="limitRuleRecordColumns">
		id,
		limit_rule_id,
		limit_rule_name,
		limit_rule_serial_number,
		standard_unit_serial_number,
		product_unit_id,
		product_unit_serial_number,
		create_userid,
		create_username,
		create_user_mobile,
		order_code,
		buy_sum,
		buy_money_sum,
		create_time,
		platform_id,
		limit_type,
		standard_unit_id,
		company_id,
		store_id,
		order_status
	</sql>

	<select id="findById" parameterType="com.egeo.components.order.po.LimitRuleRecordPO" resultMap="limitRuleRecordMap">
		SELECT
		<include refid="limitRuleRecordColumns" />
		FROM limit_rule_record
		WHERE id = #{po.id}
	</select>

	<select id="findOfPage" resultMap="limitRuleRecordMap">
		SELECT
		<include refid="limitRuleRecordColumns" />
		FROM limit_rule_record
		<where>
			<if test="po.limitRuleId != null">
				and limit_rule_id = #{po.limitRuleId}
			</if>
			<if test="po.limitRuleName != null">
				and limit_rule_name like concat('%',#{po.limitRuleName},'%')
			</if>
			<if test="po.limitRuleSerialNumber != null">
				and limit_rule_serial_number like concat('%',#{po.limitRuleSerialNumber},'%') 
			</if>
			<if test="po.standardUnitSerialNumber != null">
				and standard_unit_serial_number like concat('%',#{po.standardUnitSerialNumber},'%')
			</if>
			<if test="po.productUnitId != null">
				and product_unit_id = #{po.productUnitId}
			</if>
			<if test="po.productUnitSerialNumber != null">
				and product_unit_serial_number like concat('%',#{po.productUnitSerialNumber},'%')
			</if>
			<if test="po.createUserid != null">
				and create_userid = #{po.createUserid}
			</if>
			<if test="po.createUsername != null">
				and create_username like concat('%',#{po.createUsername},'%') 
			</if>
			<if test="po.createUserMobile != null">
				and create_user_mobile like concat('%',#{po.createUserMobile},'%') 
			</if>
			<if test="po.orderCode != null">
				and order_code like concat('%',#{po.orderCode},'%') 
			</if>
			<if test="po.buySum != null">
				and buy_sum = #{po.buySum}
			</if>
			<if test="po.buyMoneySum != null">
				and buy_money_sum = #{po.buyMoneySum}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>		
			<otherwise>
				ORDER BY id desc		
			</otherwise>
		</choose>
		<if test="page != null">
		limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>
	
	<select id="countOfPage" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		FROM limit_rule_record
		<where>
			<if test="po.limitRuleId != null">
				and limit_rule_id = #{po.limitRuleId}
			</if>
			<if test="po.limitRuleName != null">
				and limit_rule_name like concat('%',#{po.limitRuleName},'%')
			</if>
			<if test="po.limitRuleSerialNumber != null">
				and limit_rule_serial_number like concat('%',#{po.limitRuleSerialNumber},'%') 
			</if>
			<if test="po.standardUnitSerialNumber != null">
				and standard_unit_serial_number like concat('%',#{po.standardUnitSerialNumber},'%')
			</if>
			<if test="po.productUnitId != null">
				and product_unit_id = #{po.productUnitId}
			</if>
			<if test="po.productUnitSerialNumber != null">
				and product_unit_serial_number like concat('%',#{po.productUnitSerialNumber},'%')
			</if>
			<if test="po.createUserid != null">
				and create_userid = #{po.createUserid}
			</if>
			<if test="po.createUsername != null">
				and create_username like concat('%',#{po.createUsername},'%') 
			</if>
			<if test="po.createUserMobile != null">
				and create_user_mobile like concat('%',#{po.createUserMobile},'%') 
			</if>
			<if test="po.orderCode != null">
				and order_code like concat('%',#{po.orderCode},'%') 
			</if>
			<if test="po.buySum != null">
				and buy_sum = #{po.buySum}
			</if>
			<if test="po.buyMoneySum != null">
				and buy_money_sum = #{po.buyMoneySum}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
		</where>
	</select>
	
	<select id="findAll" resultMap="limitRuleRecordMap">
		SELECT
		<include refid="limitRuleRecordColumns" />
		FROM limit_rule_record
		<where>
			<if test="po.limitRuleId != null">
				and limit_rule_id = #{po.limitRuleId}
			</if>
			<if test="po.limitRuleName != null">
				and limit_rule_name = #{po.limitRuleName}
			</if>
			<if test="po.limitRuleSerialNumber != null">
				and limit_rule_serial_number = #{po.limitRuleSerialNumber}
			</if>
			<if test="po.standardUnitSerialNumber != null">
				and standard_unit_serial_number = #{po.standardUnitSerialNumber}
			</if>
			<if test="po.productUnitId != null">
				and product_unit_id = #{po.productUnitId}
			</if>
			<if test="po.productUnitSerialNumber != null">
				and product_unit_serial_number = #{po.productUnitSerialNumber}
			</if>
			<if test="po.createUserid != null">
				and create_userid = #{po.createUserid}
			</if>
			<if test="po.createUsername != null">
				and create_username = #{po.createUsername}
			</if>
			<if test="po.createUserMobile != null">
				and create_user_mobile = #{po.createUserMobile}
			</if>
			<if test="po.orderCode != null">
				and order_code = #{po.orderCode}
			</if>
			<if test="po.buySum != null">
				and buy_sum = #{po.buySum}
			</if>
			<if test="po.buyMoneySum != null">
				and buy_money_sum = #{po.buyMoneySum}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>			
			<otherwise>
				ORDER BY id desc		
			</otherwise>
		</choose>
	</select>
	
	<select id="findBuySumByLimitRuleId" resultType="java.lang.Long">
		SELECT
		sum(buy_sum) buy_sum
		FROM limit_rule_record
		where limit_rule_id = #{limitRuleId}
	</select>

	<select id="findBuySumByLimitRuleIdPlatformId" resultType="java.lang.Long">
		SELECT
		sum(buy_sum) buy_sum
		FROM limit_rule_record
		where limit_rule_id = #{limitRuleId} and platform_id = #{platformId}
	</select>
	
	<select id="findBuyMoneySumByLimitRuleId" resultType="java.math.BigDecimal">
		SELECT
		sum(buy_money_sum) buy_sum
		FROM limit_rule_record
		where limit_rule_id = #{limitRuleId}
	</select>
	
	<select id="findByPeriodTypeUserIdLimitRuleId" resultMap="limitRuleRecordMap">
		SELECT
		<include refid="limitRuleRecordColumns" />
		FROM limit_rule_record
		<where>
			<if test="limitRuleId != null">
				and limit_rule_id = #{limitRuleId}
			</if>
			<if test="userId != null">
				and create_userid = #{userId}
			</if>
			<if test="periodType != null">
				<if test="periodType == 1">
				and create_time >= CURRENT_TIMESTAMP - INTERVAL 1 DAY
				</if>
				<if test="periodType == 2">
				and create_time >= CURRENT_TIMESTAMP - INTERVAL 1 MONTH
				</if>
				<if test="periodType == 3">
				and create_time >= CURRENT_TIMESTAMP - INTERVAL 1 year
				</if>
			</if>
			<if test="platformId != null">
				and platform_id = #{platformId}
			</if>
		</where>
	</select>
	
	<select id="selectLimitStatistic" resultMap="limitRuleRecordMap">
		select 
		sum(buy_sum) buy_sum,
		sum(buy_money_sum) buy_money_sum 
		from limit_rule_record
		where limit_rule_id = #{limitRuleId}
		<if test="standardUnitId != null">
			and standard_unit_id = #{standardUnitId}
		</if>
		<if test="standardUnitIdList != null and standardUnitIdList.size()>0">
			and standard_unit_id in
			<foreach collection="standardUnitIdList" item="suId" open="(" separator=","
					 close=")">
				#{suId}
			</foreach>
		</if>
		<if test="userId != null">
			and create_userid = #{userId}
		</if>
		<if test="storeId != null">
			and store_id = #{storeId}
		</if>
		<if test="companyId != null">
			and company_id = #{companyId}
		</if>
		<if test="periodType != null">
			<if test="periodType == 1">
				and create_time >= CURRENT_TIMESTAMP - INTERVAL 1 DAY
			</if>
			<if test="periodType == 2">
				and create_time >= CURRENT_TIMESTAMP - INTERVAL 1 MONTH
			</if>
			<if test="periodType == 3">
				and create_time >= CURRENT_TIMESTAMP - INTERVAL 1 year
			</if>
		</if>
		<if test="orderStatus!=null">
			AND order_status=#{orderStatus}
		</if>
		<if test="orderStatus==null">
			AND order_status!=0
		</if>
	</select>
</mapper>
	