<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.egeo.components.user.dao.write.UniAuthRolesMapper">
    <resultMap id="UniauthRoleResultMapper" type="com.egeo.components.user.bean.UniAuthRoles">
        <id column="rid" property="rid"/>
        <result column="rcode" property="rcode"/>
        <result column="rname" property="rname"/>
        <result column="rstate" property="rstate"/>
        <result column="department_code" property="departmentCode"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="desc" property="desc"/>
        <result column="app_id" property="appId"/>
        <result column="app_code" property="appCode"/>
    </resultMap>

    <resultMap id="UniauthRoleDepartmentNameResultMapper" type="com.egeo.components.user.bean.UniAuthRoles"
               extends="UniauthRoleResultMapper">
        <association property="departmentName" column="department_code"
                     select="com.egeo.components.user.dao.write.UniauthDepartmentMapper.findNameByCode"/>
    </resultMap>

    <sql id="commonColumns">
		 rid
		, rcode
		, rname
		, rstate
		, department_code
		, DATE_FORMAT(create_time, '%Y-%m-%d %T') create_time
		, DATE_FORMAT(update_time, '%Y-%m-%d %T') update_time
		, create_by
		, update_by
		, `desc`
		, app_id
		, app_code
	</sql>

    <sql id="commonCondition">
        <if test="rid!= null and rid!= ''">
            AND rid=#{rid}
        </if>
        <if test="rcode!= null and rcode!= ''">
            AND rcode=#{rcode}
        </if>
        <if test="rname!= null and rname!= ''">
            AND rname=#{rname}
        </if>
        <if test="rstate!= null and rstate!= ''">
            AND rstate=#{rstate}
        </if>
        <if test="departmentCode!= null and departmentCode!= ''">
            AND department_code=#{departmentCode}
        </if>
        <if test="createTime!= null and createTime!= ''">
            AND create_time=STR_TO_DATE(#{createTime},'%Y-%m-%d %T')
        </if>
        <if test="updateTime!= null and updateTime!= ''">
            AND update_time=STR_TO_DATE(#{updateTime},'%Y-%m-%d %T')
        </if>
        <if test="createBy!= null and createBy!= ''">
            AND create_by=#{createBy}
        </if>
        <if test="updateBy!= null and updateBy!= ''">
            AND update_by=#{updateBy}
        </if>
        <if test="desc!= null and desc!= ''">
            AND `desc`=#{desc}
        </if>
        <if test="appId!= null and appId!= ''">
            AND app_id=#{appId}
        </if>
        <if test="appCode!= null and appCode!= ''">
            AND app_code=#{appCode}
        </if>
    </sql>

    <insert id="insert" parameterType="com.egeo.components.user.bean.UniAuthRoles" keyProperty="rid" useGeneratedKeys="true">
		<![CDATA[ INSERT INTO uniauth_role (
				 rcode
				, rname
				, rstate
				, department_code
				, create_time
				, update_time
				, create_by
				, update_by
				, `desc`
				, app_id
				, app_code
				 ) VALUES (
				 #{rcode}
				, #{rname}
				, #{rstate}
				, #{departmentCode}
				, STR_TO_DATE(#{createTime},'%Y-%m-%d %T')
				, STR_TO_DATE(#{updateTime},'%Y-%m-%d %T')
				, #{createBy}
				, #{updateBy}
				, #{desc}
				, #{appId}
				, #{appCode}
  				) ]]>
	</insert>
    <update id="update" parameterType="com.egeo.components.user.bean.UniAuthRoles">
		<![CDATA[ UPDATE uniauth_role SET
			 rid=#{rid}
			, rcode=#{rcode}
			, rname=#{rname}
			, rstate=#{rstate}
			, department_code=#{departmentCode}
			, create_time=STR_TO_DATE(#{createTime},'%Y-%m-%d %T')
			, update_time=STR_TO_DATE(#{updateTime},'%Y-%m-%d %T')
			, create_by=#{createBy}
			, update_by=#{updateBy}
			, `desc`=#{desc}
			, app_id=#{appId}
			, app_code=#{appCode}
		WHERE rid = #{rid}  ]]>
	</update>
    <update id="updatePart" parameterType="com.egeo.components.user.bean.UniAuthRoles">
        <![CDATA[ UPDATE uniauth_role SET rid = #{rid} ]]>
        <if test="rcode!= null">
            , rcode=#{rcode}
        </if>
        <if test="rname!= null">
            , rname=#{rname}
        </if>
        <if test="rstate!= null">
            , rstate=#{rstate}
        </if>
        <if test="departmentCode!= null">
            , department_code=#{departmentCode}
        </if>
        <if test="createTime!= null">
            , create_time=STR_TO_DATE(#{createTime}, '%Y-%m-%d %T')
        </if>
        <if test="updateTime!= null">
            , update_time=STR_TO_DATE(#{updateTime}, '%Y-%m-%d %T')
        </if>
        <if test="createBy!= null">
            , create_by=#{createBy}
        </if>
        <if test="updateBy!= null">
            , update_by=#{updateBy}
        </if>
        <if test="desc!= null">
            , `desc`=#{desc}
        </if>
        <if test="appId!= null">
            , app_id=#{appId}
        </if>
        <if test="appCode!= null">
            , app_code=#{appCode}
        </if>
        <![CDATA[ WHERE rid = #{rid}  ]]>
    </update>

    <select id="getByPK" parameterType="java.lang.Integer" resultMap="UniauthRoleResultMapper">
        <![CDATA[ SELECT ]]>
        <include refid="commonColumns"/>
        FROM uniauth_role WHERE rid = #{rid}
    </select>
    <select id="listByPageInfo" parameterType="com.egeo.components.user.bean.UniAuthRoles" resultMap="UniauthRoleDepartmentNameResultMapper">
        <![CDATA[ SELECT ]]>
            rid
            , rcode
            , rname
            , rstate
            , department_code
            , DATE_FORMAT(create_time, '%Y-%m-%d %T') create_time
            , update_by
        FROM uniauth_role WHERE rstate != -1
        <if test="rcode!= null and rcode!= ''">
            AND rcode=#{rcode}
        </if>
        <if test="rname!= null and rname!= ''">
            AND rname=#{rname}
        </if>
        <if test="departmentCode!= null and departmentCode!= ''">
            AND department_code=#{departmentCode}
        </if>
        <if test="minCreateTime!= null and minCreateTime!= ''">
            AND create_time >= STR_TO_DATE(#{minCreateTime},'%Y-%m-%d %T')
        </if>
        <if test="maxCreateTime!= null and maxCreateTime!= ''">
            AND create_time <![CDATA[ < ]]> DATE_ADD(#{maxCreateTime},INTERVAL 1 DAY)
        </if>
        <if test="parentCode!= null and parentCode!= ''">
            AND department_code IN (
                SELECT
                  department_code
                FROM uniauth_department
                WHERE parent_codes LIKE (
                    SELECT concat(parent_codes, department_code, '-%')
                    FROM uniauth_department
                    WHERE department_code=#{parentCode}
                    AND department_state != -1
                )
                UNION
                SELECT #{parentCode} department_code
            )
        </if>
    </select>

    <select id="getByUser" parameterType="String" resultMap="UniauthRoleResultMapper">
        <![CDATA[ SELECT ]]>
            rid
            , rcode
            , rname
        FROM uniauth_role WHERE rstate != -1
        <if test="parentCode!= null and parentCode!= ''">
            AND department_code IN (
                SELECT
                  department_code
                FROM uniauth_department
                WHERE parent_codes LIKE (
                    SELECT concat(parent_codes, department_code, '-%')
                    FROM uniauth_department
                    WHERE department_code=#{parentCode}
                    AND department_state != -1
                )
                UNION
                SELECT #{parentCode} department_code
            )
        </if>
        <if test="departmentCode != null and departmentCode != ''">
            AND department_code=#{departmentCode}
        </if>
        ORDER BY department_code
    </select>

    <select id="findByCount" parameterType="com.egeo.components.user.bean.UniAuthRoles" resultType="int">
        SELECT count(1) AS totalcount FROM uniauth_role WHERE 1=1
        <include refid="commonCondition"/>
    </select>

    <select id="findUniAuthRoleByUid" parameterType="int" resultMap="UniauthRoleDepartmentNameResultMapper">
        <![CDATA[ SELECT ]]>
            r.rid
            , r.rcode
            , r.rname
            , r.department_code
        FROM uniauth_role r, uniauth_user_role ur WHERE r.rid=ur.rid AND ur.uid = #{uid} AND rstate != -1
    </select>

    <select id="findUniAuthAccountRoleByUid" parameterType="int" resultMap="UniauthRoleDepartmentNameResultMapper">
        <![CDATA[ SELECT ]]>
        r.rid
        , r.rcode
        , r.rname
        , r.department_code
        FROM uniauth_role r, uniauth_user_account_role ur WHERE r.rid=ur.rid AND ur.uid = #{uid} AND rstate != -1
    </select>

  <select id="all" resultType="com.egeo.components.user.bean.UniAuthRoles">
  		SELECT * FROM uniauth_role
  </select>
	<select id="getRidList" resultType="com.egeo.components.user.bean.UniAuthRoles" parameterType="java.lang.String">
        SELECT ur.rid FROM uniauth_user_role ur WHERE ur.uid =(
            SELECT id FROM uniauth_user_info u WHERE u.uuid =#{uuid}
        )
    </select>

    <select id="getRoleByUuid" parameterType="String" resultMap="UniauthRoleResultMapper">
        SELECT r.rid, r.rcode, r.rname, r.department_code
        FROM u_user i, uniauth_user_role ur, uniauth_role r
	    WHERE i.id=ur.uid AND ur.rid=r.rid AND i.id=#{uuid} AND rstate != -1
    </select>

    <select id="getAccountRoleByUuid" parameterType="String" resultMap="UniauthRoleResultMapper">
        SELECT r.rid, r.rcode, r.rname, r.department_code
        FROM uniauth_user_info i, uniauth_user_account_role ur, uniauth_role r
        WHERE i.id=ur.uid AND ur.rid=r.rid AND i.uuid=#{uuid} AND rstate != -1
    </select>
    
     <select id="getByParams" parameterType="String" resultMap="UniauthRoleResultMapper">
        <![CDATA[ SELECT ]]>
        <include refid="commonColumns"/>
        FROM uniauth_role WHERE rstate != -1
        <if test="roleParams!= null and roleParams!= ''">
        	AND  FIND_IN_SET(#{roleParams},params) 
        </if>
    </select>
    
    
</mapper>