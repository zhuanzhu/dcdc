<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.egeo.components.user.dao.read.UserExtendReadDAO">

	<select id="queryFullUserExtendPageTotalSize" resultType="java.lang.Integer">
		select count(0)
		<include refid="queryFullUserExtendPage_MainCond" />
	</select>

	<select id="findBaiDuChannelId" resultType="java.lang.String">
		SELECT baidu_channel_id from u_user_extend WHERE id = #{userId}
	</select>

	<select id="queryFullUserExtendPage" resultMap="userExtend">
		select a.*,b.company_id,b.mail
		<include refid="queryFullUserExtendPage_MainCond" />
		order by a.name_py
		limit
		#{page.limitStart},#{page.pageSize}
	</select>
	<select id="queryFullUserExtend" resultMap="userExtend">
		select a.*,b.company_id,b.mail
		from u_user_extend a
		left join u_user b on a.id=b.id
		left join u_user_platform c on a.id=c.user_id
		<where>
			b.id IN
			<foreach collection="userIdList" item="userId" open="(" close=")" separator=",">
				#{userId}
			</foreach>
		</where>
		order by a.name_py
	</select>

	<sql id="queryFullUserExtendPage_MainCond">
		from u_user_extend a
		left join u_user b on a.id=b.id
		left join u_user_platform c on a.id=c.user_id
		<where>
			<if test="condition.name!=null">
				and a.name like concat('%',#{condition.name},'%')
			</if>
			<if test="condition.companyId!=null">
				and b.company_id=#{condition.companyId}
			</if>
			<if test="condition.mail!=null">
				and b.mail like concat('%',#{condition.mail},'%')
			</if>
			<if test="condition.companyId!=null">
				and b.company_id=#{condition.companyId}
			</if>
			<if test="condition.platformId!=null">
				and c.platform_id=#{condition.platformId}
			</if>
		</where>
	</sql>

	<select id="queryUserExtendsByEmail" resultMap="userExtend">
		select * from
		u_user_extend
		where id=(select id from u_user where mail=#{email})
	</select>

	<select id="queryUserExtendsByBirthDate" resultMap="userExtend">
		select * from
		u_user_extend
		where
		id in (select id from u_user where company_id=#{companyId} and
		is_available=1)
		and
		DATE_FORMAT(birthday,'%m-%d')=DATE_FORMAT(#{birthDate},'%m-%d')
		and
		name is not null
		and name != ''
		order by name_py
	</select>

	<select id="queryEarliestBirthDate" resultType="java.util.Date">
		select
		birthday
		from u_user_extend
		where
		id in (select id from u_user where
		company_id=#{companyId} and is_available=1)
		and birthday is not null
		order by DATE_FORMAT(birthday,'%m-%d')
		limit 0,1
	</select>

	<select id="queryNearestBirthDateThisYear" resultType="java.util.Date">
		select
		birthday from u_user_extend
		where
		DATE_FORMAT(birthday,'%m-%d')>=DATE_FORMAT(CURDATE(),'%m-%d')
		and id in
		(select id from u_user where company_id=#{companyId} and
		is_available=1)
		and birthday is not null
		order by
		DATE_FORMAT(birthday,'%m-%d')
		limit 0,1
	</select>

	<select id="searchUsers" resultMap="depMember">
		select
		a.id,a.head_pic_url,a.name,b.mail
		from u_user_extend a
		left join u_user
		b
		on a.id=b.id
		where
		(b.mail like concat('%',#{keyWord},'%') or a.name
		like
		concat('%',#{keyWord},'%'))
		and a.id &lt;&gt; #{userId}
		and
		b.company_id=#{companyId}
		and a.name is not null
	</select>

	<resultMap type="com.egeo.components.user.po.DepMemberPO" id="depMember">
		<result column="id" property="id" />
		<result column="head_pic_url" property="face" />
		<result column="name" property="name" />
		<result column="mail" property="mail" />
	</resultMap>

	<select id="queryDepMemberTotalCountExceptThisId" resultType="java.lang.Integer">
		select count(0) from u_user_extend a
		left join u_user b
		on a.id=b.id
		where a.id in
		(select user_id from u_user_welfare where
		department_id=#{depId} and user_id &lt;&gt; #{userId})
		and a.name is
		not null
		and a.name != ''
	</select>

	<select id="queryDepMemberPageExceptThisId" resultMap="depMember">
		select
		a.id,a.head_pic_url,a.name,b.mail
		from u_user_extend a
		left join u_user
		b
		on a.id=b.id
		where a.id in
		(select user_id from u_user_welfare where
		department_id=#{depId} and user_id &lt;&gt; #{userId})
		and a.name is
		not null
		and a.name != ''
		order by a.name_py
		limit
		#{page.limitStart},#{page.pageSize}
	</select>

	<select id="querySoonEntrydayUsers" resultMap="userExtend">
		select * from
		u_user_extend
		where
		id in (
		select id from u_user_welfare
		where user_id in
		(select id from u_user where company_id=#{companyId})
		and
		(cast(concat(year(CURRENT_DATE()),DATE_FORMAT(entry_time,'-%m-%d')) as
		date)-CURDATE()) BETWEEN 0 and 2
		)
	</select>

	<select id="querySoonBirthdayUsers" resultMap="userExtend">
		select * from
		u_user_extend
		where
		id in (select id from u_user where
		company_id=#{companyId})
		birthday is
		not null
		and
		(cast(concat(year(CURRENT_DATE()),DATE_FORMAT(birthday,'-%m-%d')) as
		date)-CURDATE()) BETWEEN 0 and 2;
	</select>

	<select id="queryUserExtendsByIds" resultMap="userExtend">
		select * from u_user_extend
		where id in
		<foreach collection="ids" item="id" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</select>

	<select id="queryUserPageTotalCountByDepartmentId" resultType="java.lang.Integer">
		select count(0)
		from u_user_extend
		where id in (
		select id from
		u_user_welfare
		where
		department_id=#{departmentId}
		)
	</select>

	<select id="queryUserPageByDepartmentId" resultMap="userExtend">
		select * from
		u_user_extend
		where id in (
		select id from u_user_welfare
		where
		department_id=#{departmentId}
		)
		order by name
		limit
		#{page.limitStart},#{page.pageSize}
	</select>

	<select id="queryUserPageTotalCountByCompanyId" resultType="java.lang.Integer">
		select count(0)
		from u_user_extend
		where id in (
		select id from
		u_user_welfare
		where
		company_id=#{companyId}
		)
	</select>


	<select id="queryUserPageByCompanyId" resultMap="userExtend">
		select * from
		u_user_extend
		where id in (
		select id from u_user_welfare
		where
		company_id=#{companyId}
		)
		order by name
		limit
		#{page.limitStart},#{page.pageSize}
	</select>

	<resultMap type="com.egeo.components.user.po.UserExtendPO" id="userExtend">
		<result property="id" column="id" />
		<result property="sex" column="sex" />
		<result property="nickname" column="nickname" />
		<result property="headPicUrl" column="head_pic_url" />
		<result property="name" column="name" />
		<result property="regtime" column="regtime" />
		<result property="birthday" column="birthday" />
		<result property="mobile" column="mobile" />
		<result property="qq" column="qq" />
		<result property="memberCode" column="member_code" />
		<result property="remark" column="remark" />
		<result property="lastlogin" column="lastlogin" />
		<result property="activityInfo" column="activity_info" />
		<result property="isComplete" column="is_complete" />
		<result property="deviceId" column="device_id" />
		<result property="deviceType" column="device_type" />
		<result property="weixin" column="weixin" />
		<result property="workaddressId" column="workaddress_id" />
		<result property="status" column="status" />
		<result property="accountStatus" column="account_status" />
		<result property="isAvailable" column="is_available" />
		<result property="invalidTime" column="invalid_time" />
		<result property="address" column="address" />
		<result property="isDeleted" column="is_deleted" />
		<result property="createTime" column="create_time" />
		<result property="updateTime" column="update_time" />
		<result property="isAdministrator" column="is_administrator" />
		<result property="companyId" column="company_id" />
		<result property="quitTime" column="quit_time" />
		<result property="invalidTime" column="invalid_time" />
		<result property="mail" column="mail" />
		<result property="baiduChannelId" column="baidu_channel_id" />
		<result property="channelId" column="channel_id" />
		<result property="campaignCode" column="campaign_code" />
		<result property="registerStoreId" column="register_store_id" />
		<result property="channelSource" column="channel_source" />
		<result property="idCardNo" column="id_card_no" />
		</resultMap>

	<resultMap type="com.egeo.components.user.condition.UserExtendCondition"
		id="userExtendCondition" extends="userExtend">
		<result property="companyId" column="company_id" />
		<result property="companyName" column="company_name" />
		<result property="departmentId" column="department_id" />
		<result property="departmentName" column="department_name" />
		<result property="entryTime" column="entry_time" />
		<result property="mail" column="mail" />
		<result property="paymentCode" column="payment_code" />
		<result property="backgrondImg" column="backgrond_img" />
		<result property="companyLogo" column="company_logo" />
		<result property="importRecordsId" column="import_records_id" />
	</resultMap>

	<sql id="userExtendColumns">
		id,
		sex,
		nickname,
		head_pic_url,
		name,
		regtime,
		birthday,
		mobile,
		qq,
		member_code,
		remark,
		lastlogin,
		activity_info,
		is_complete,
		device_id,
		device_type,
		weixin,
		workaddress_id,
		status,
		account_status,
		invalid_time,
		address,
		is_administrator,
		is_deleted,
		create_time,
		update_time,
		baidu_channel_id,
		register_store_id,
		channel_source,
		id_card_no
	</sql>
	<sql id="userStoreExtendColumns">
		a.id,
		a.sex,
		a.nickname,
		a.head_pic_url,
		a.name,
		a.regtime,
		a.birthday,
		a.qq,
		a.member_code,
		a.remark,
		a.lastlogin,
		a.activity_info,
		a.is_complete,
		a.device_id,
		a.device_type,
		a.weixin,
		a.workaddress_id,
		a.status,
		a.account_status,
		a.invalid_time,
		a.address,
		a.is_administrator,
		a.baidu_channel_id,
		a.channel_source,
		a.id_card_no
	</sql>
	<select id="findById" parameterType="com.egeo.components.user.po.UserExtendPO"
		resultMap="userExtend">
		SELECT
		<include refid="userExtendColumns" />
		FROM u_user_extend
		WHERE id = #{po.id}
	</select>

	<select id="findOfPage" resultMap="userExtend">
		SELECT
		<include refid="userExtendColumns" />
		FROM u_user_extend
		<where>
			<if test="po.sex != null">
				and sex = #{po.sex}
			</if>
			<if test="po.nickname != null">
				and nickname = #{po.nickname}
			</if>
			<if test="po.headPicUrl != null">
				and head_pic_url = #{po.headPicUrl}
			</if>
			<if test="po.name != null">
				and name = #{po.name}
			</if>
			<if test="po.regtime != null">
				and regtime = #{po.regtime}
			</if>
			<if test="po.birthday != null">
				and birthday = #{po.birthday}
			</if>
			<if test="po.mobile != null">
				and mobile = #{po.mobile}
			</if>
			<if test="po.qq != null">
				and qq = #{po.qq}
			</if>
			<if test="po.memberCode != null">
				and member_code = #{po.memberCode}
			</if>
			<if test="po.remark != null">
				and remark = #{po.remark}
			</if>
			<if test="po.lastlogin != null">
				and lastlogin = #{po.lastlogin}
			</if>
			<if test="po.activityInfo != null">
				and activity_info = #{po.activityInfo}
			</if>
			<if test="po.isComplete != null">
				and is_complete = #{po.isComplete}
			</if>
			<if test="po.deviceId != null">
				and device_id = #{po.deviceId}
			</if>
			<if test="po.deviceType != null">
				and device_type = #{po.deviceType}
			</if>
			<if test="po.weixin != null">
				and weixin = #{po.weixin}
			</if>
			<if test="po.workaddressId != null">
				and workaddress_id = #{po.workaddressId}
			</if>
			<if test="po.status != null">
				and status = #{po.status}
			</if>
			<if test="po.accountStatus != null">
				and account_status = #{po.accountStatus}
			</if>
			<if test="po.invalidTime != null">
				and invalid_time = #{po.invalidTime}
			</if>
			<if test="po.address != null">
				and address = #{po.address}
			</if>
			<if test="po.isAdministrator != null">
				and is_administrator = #{po.isAdministrator}
			</if>
			<if test="po.isDeleted != null">
				and is_deleted = #{po.isDeleted}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY id desc
			</otherwise>
		</choose>
		<if test="page != null">
			limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>

	<select id="countOfPage" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		FROM u_user_extend
		<where>
			<if test="po.sex != null">
				and sex = #{po.sex}
			</if>
			<if test="po.nickname != null">
				and nickname = #{po.nickname}
			</if>
			<if test="po.headPicUrl != null">
				and head_pic_url = #{po.headPicUrl}
			</if>
			<if test="po.name != null">
				and name = #{po.name}
			</if>
			<if test="po.regtime != null">
				and regtime = #{po.regtime}
			</if>
			<if test="po.birthday != null">
				and birthday = #{po.birthday}
			</if>
			<if test="po.mobile != null">
				and mobile = #{po.mobile}
			</if>
			<if test="po.qq != null">
				and qq = #{po.qq}
			</if>
			<if test="po.memberCode != null">
				and member_code = #{po.memberCode}
			</if>
			<if test="po.remark != null">
				and remark = #{po.remark}
			</if>
			<if test="po.lastlogin != null">
				and lastlogin = #{po.lastlogin}
			</if>
			<if test="po.activityInfo != null">
				and activity_info = #{po.activityInfo}
			</if>
			<if test="po.isComplete != null">
				and is_complete = #{po.isComplete}
			</if>
			<if test="po.deviceId != null">
				and device_id = #{po.deviceId}
			</if>
			<if test="po.deviceType != null">
				and device_type = #{po.deviceType}
			</if>
			<if test="po.weixin != null">
				and weixin = #{po.weixin}
			</if>
			<if test="po.workaddressId != null">
				and workaddress_id = #{po.workaddressId}
			</if>
			<if test="po.status != null">
				and status = #{po.status}
			</if>
			<if test="po.accountStatus != null">
				and account_status = #{po.accountStatus}
			</if>
			<if test="po.invalidTime != null">
				and invalid_time = #{po.invalidTime}
			</if>
			<if test="po.address != null">
				and address = #{po.address}
			</if>
			<if test="po.isAdministrator != null">
				and is_administrator = #{po.isAdministrator}
			</if>
			<if test="po.isDeleted != null">
				and is_deleted = #{po.isDeleted}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
		</where>
	</select>

	<select id="findAll" resultMap="userExtend">
		SELECT
		<include refid="userExtendColumns" />
		FROM u_user_extend
		<where>
			<if test="po.sex != null">
				and sex = #{po.sex}
			</if>
			<if test="po.nickname != null">
				and nickname = #{po.nickname}
			</if>
			<if test="po.headPicUrl != null">
				and head_pic_url = #{po.headPicUrl}
			</if>
			<if test="po.name != null">
				and name = #{po.name}
			</if>
			<if test="po.regtime != null">
				and regtime = #{po.regtime}
			</if>
			<if test="po.birthday != null">
				and birthday = #{po.birthday}
			</if>
			<if test="po.mobile != null">
				and mobile = #{po.mobile}
			</if>
			<if test="po.qq != null">
				and qq = #{po.qq}
			</if>
			<if test="po.memberCode != null">
				and member_code = #{po.memberCode}
			</if>
			<if test="po.remark != null">
				and remark = #{po.remark}
			</if>
			<if test="po.lastlogin != null">
				and lastlogin = #{po.lastlogin}
			</if>
			<if test="po.activityInfo != null">
				and activity_info = #{po.activityInfo}
			</if>
			<if test="po.isComplete != null">
				and is_complete = #{po.isComplete}
			</if>
			<if test="po.deviceId != null">
				and device_id = #{po.deviceId}
			</if>
			<if test="po.deviceType != null">
				and device_type = #{po.deviceType}
			</if>
			<if test="po.weixin != null">
				and weixin = #{po.weixin}
			</if>
			<if test="po.workaddressId != null">
				and workaddress_id = #{po.workaddressId}
			</if>
			<if test="po.status != null">
				and status = #{po.status}
			</if>
			<if test="po.accountStatus != null">
				and account_status = #{po.accountStatus}
			</if>
			<if test="po.invalidTime != null">
				and invalid_time = #{po.invalidTime}
			</if>
			<if test="po.address != null">
				and address = #{po.address}
			</if>
			<if test="po.isAdministrator != null">
				and is_administrator = #{po.isAdministrator}
			</if>
			<if test="po.isDeleted != null">
				and is_deleted = #{po.isDeleted}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY id desc
			</otherwise>
		</choose>
	</select>

	<select id="userExtendByUserId" resultMap="userExtendCondition">
		select
		ue.id,
		ue.sex,
		ue.nickname,
		ue.head_pic_url,
		ue.name,
		ue.regtime,
		ue.birthday,
		ue.mobile,
		ue.qq,
		ue.member_code,
		ue.remark,
		ue.lastlogin,
		ue.activity_info,
		ue.is_complete,
		ue.device_id,
		ue.device_type,
		ue.weixin,
		ue.workaddress_id,
		ue.status,
		ue.account_status,
		ue.address,
		ue.is_deleted,
		ue.create_time,
		ue.update_time,
		u.company_id,
		c.company_name,
		ue.channel_source,
		ue.id_card_no
		from
		u_user_extend ue
		LEFT
		JOIN u_user u on u.id = ue.id
		LEFT JOIN u_company
		c on c.id =
		u.company_id
		WHERE ue.id = #{userId}
	</select>

	<select id="userByUserId" resultMap="userExtendCondition">
		select
		ue.id,
		ue.sex,
		ue.nickname,
		ue.head_pic_url,
		ue.name,
		ue.regtime,
		ue.birthday,
		u.mobile,
		u.payment_code,
		u.mail,
		u.is_available,
		ue.qq,
		ue.member_code,
		ue.remark,
		ue.lastlogin,
		ue.activity_info,
		ue.is_complete,
		ue.device_id,
		ue.device_type,
		ue.weixin,
		ue.workaddress_id,
		ue.status,
		ue.address,
		ue.is_deleted,
		ue.create_time,
		ue.update_time,
		ue.account_status,
		ue.is_administrator,
		ue.channel_source,
		ue.id_card_no,
		uw.department_id,
		d.department_name,
		uw.entry_time,
		u.company_id,
		c.company_name,
		c.backgrond_img,
		c.company_logo
		from u_user_extend ue
		LEFT
		JOIN
		u_user_welfare uw on uw.user_id = ue.id
		LEFT JOIN u_user u on u.id=ue.id
		LEFT JOIN u_company c on c.id = u.company_id
		LEFT JOIN u_department d on d.id = uw.department_id
		WHERE ue.id = #{userId}
	</select>

	<select id="userAllOfPage" resultMap="userExtendCondition">
		SELECT
		u.id,
		ue.`name`,
		ue.sex,
		ue.birthday,
		ue.mobile,
		uw.entry_time,
		u.mail,
		d.department_name
		FROM u_user u
		LEFT JOIN u_user_extend ue on
		ue.id = u.id
		LEFT JOIN u_user_welfare uw on uw.user_id = u.id
		LEFT JOIN
		u_department d on d.id = uw.department_id
		LEFT JOIN u_user_platform up
		on up.user_id = u.id
		<where>
			<if test="true">
				and u.is_deleted = 0
			</if>
			<if test="po.companyId != null">
				and u.company_id = #{po.companyId}
			</if>
			<if test="po.name != null">
				and ue.name = #{po.name}
			</if>
			<if test="po.sex != null">
				and ue.sex = #{po.sex}
			</if>
			<if test="po.departmentId != null">
				and uw.department_id = #{po.departmentId}
			</if>
			<if test="po.birthdayStartTime != null">
				and ue.birthday > #{po.birthdayStartTime}
			</if>
			<if test="po.birthdayFinishTime != null">
				and #{po.birthdayFinishTime} > ue.birthday
			</if>
			<if test="po.entryStartTime != null">
				and uw.entry_time > #{po.entryStartTime}
			</if>
			<if test="po.entryFinishTime != null">
				and #{po.entryFinishTime} > uw.entry_time
			</if>
			<if test="po.platformId != null">
				and up.platform_id = #{po.platformId}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY uw.entry_time desc
			</otherwise>
		</choose>
		<if test="page != null">
			limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>

	<select id="countuserAllOfPage" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		FROM u_user u
		LEFT JOIN u_user_extend ue on ue.id =
		u.id
		LEFT JOIN u_user_welfare uw on uw.user_id = u.id
		LEFT JOIN
		u_department d on d.id = uw.department_id
		LEFT JOIN u_user_platform up
		on up.user_id = u.id
		<where>
			<if test="true">
				and u.is_deleted = 0
			</if>
			<if test="po.companyId != null">
				and u.company_id = #{po.companyId}
			</if>
			<if test="po.name != null">
				and ue.name like concat('%',#{po.name},'%')
			</if>
			<if test="po.sex != null">
				and ue.sex = #{po.sex}
			</if>
			<if test="po.departmentId != null">
				and uw.department_id = #{po.departmentId}
			</if>
			<if test="po.birthdayStartTime != null">
				and ue.birthday > #{po.birthdayStartTime}
			</if>
			<if test="po.birthdayFinishTime != null">
				and #{po.birthdayFinishTime} > ue.birthday
			</if>
			<if test="po.entryStartTime != null">
				and uw.entry_time > #{po.entryStartTime}
			</if>
			<if test="po.entryFinishTime != null">
				and #{po.entryFinishTime} > uw.entry_time
			</if>
			<if test="po.platformId != null">
				and up.platform_id = #{po.platformId}
			</if>
		</where>
	</select>

	<select id="userExtendAllOfPage" resultMap="userExtendCondition">
		SELECT
		ue.id,
		ue.sex,
		ue.`name`,
		ue.birthday,
		u.mobile,
		ue.member_code,
		ue.status,
		ue.account_status,
		ue.is_deleted,
		ue.channel_id,
		ue.campaign_code,
		ue.register_store_id,
		u.mail,
		u.is_available,
		u.quit_time,
		u.company_id,
		ue.invalid_time,
		u.create_time as regtime,
		ue.id_card_no
		FROM u_user u, u_user_extend ue,
		(SELECT
		ue.id
		FROM
		(SELECT
		ue.id
		FROM u_user_extend ue
		<where>
			<if test="po.name != null">
				and ue.name like concat('%',#{po.name},'%')
			</if>
			<if test="po.sex != null">
				and ue.sex = #{po.sex}
			</if>
			<if test="po.status != null">
				and ue.status = #{po.status}
			</if>
			<if test="po.accountStatus != null">
				and ue.account_status = #{po.accountStatus}
			</if>
			<if test="po.memberCode != null">
				and ue.member_code like concat('%',#{po.memberCode},'%')
			</if>
			<if test="po.birthday != null">
				and date_format(ue.birthday,'%y-%m-%d') = date_format(#{po.birthday},'%y-%m-%d')
			</if>
			<if test="po.isAdministrator != null">
				and ue.is_administrator = #{po.isAdministrator}
			</if>
			<if test="po.channelId != null">
				and ue.channel_id = #{po.channelId}
			</if>
			<if test="po.campaignCode != null">
				and ue.campaign_code like concat('%',#{po.campaignCode},'%')
			</if>
			<if test="po.entryStartTime!=null">
				and ue.create_time >=#{po.entryStartTime}
			</if>
			<if test="po.entryFinishTime!=null">
				and #{po.entryFinishTime}  >= ue.create_time
			</if>
		</where>) ue,
		(SELECT
		u.id
		FROM u_user u
		<where>
			<if test="po.companyId != null">
				and u.company_id = #{po.companyId}
			</if>
			<if test="1==1">
				and u.type = 4
			</if>
			<if test="po.isAvailable != null">
				and u.is_available = #{po.isAvailable}
			</if>
			<if test="po.mail != null">
				and u.mail like concat('%',#{po.mail},'%')
			</if>
			<if test="po.mobile != null">
				and u.mobile like concat('%',#{po.mobile},'%')
			</if>
			<if test="companyIds != null">
				and u.company_id in
				<foreach item="companyId" collection="companyIds" separator="," open="(" close=")">
					#{companyId}
				</foreach>
			</if>
		</where>) u,
		(SELECT distinct user_id FROM u_user_platform where platform_id = #{po.platformId}) up
		where up.user_id = ue.id and ue.id = u.id
		<if test="page != null">
			limit #{page.limitStart},#{page.pageSize}
		</if>) us
		where ue.id = u.id and u.id = us.id
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY u.company_id,u.create_time
			</otherwise>
		</choose>
	</select>
	<!--
	<select id="companyAdminAccount" resultMap="userExtendCondition">
		SELECT
		ue.id,
		ue.sex,
		ue.`name`,
		ue.birthday,
		u.mobile,
		ue.member_code,
		ue.status,
		ue.account_status,
		ue.is_deleted,
		ue.channel_id,
		ue.campaign_code,
		ue.register_store_id,
		u.mail,
		u.is_available,
		u.quit_time,
		u.company_id,
		ue.invalid_time
		FROM u_user u, u_user_extend ue,
		(SELECT
		u.id
		FROM
		(SELECT
		ue.id
		FROM u_user_extend ue
		<where>
			<if test="1==1">
				and ue.is_administrator =1
			</if>
			<if test="po.sex != null">
				and ue.sex = #{po.sex}
			</if>
			<if test="po.status != null">
				and ue.status = #{po.status}
			</if>
			<if test="po.accountStatus != null">
				and ue.account_status = #{po.accountStatus}
			</if>
			<if test="po.memberCode != null">
				and ue.member_code like concat('%',#{po.memberCode},'%')
			</if>
			<if test="po.birthday != null">
				and date_format(ue.birthday,'%y-%m-%d') = date_format(#{po.birthday},'%y-%m-%d')
			</if>
			<if test="po.isAdministrator != null">
				and ue.is_administrator = #{po.isAdministrator}
			</if>
			<if test="po.channelId != null">
				and ue.channel_id = #{po.channelId}
			</if>
			<if test="po.campaignCode != null">
				and ue.campaign_code like concat('%',#{po.campaignCode},'%')
			</if>
		</where>) ue,
		(SELECT
		u.id
		FROM u_user u
		<where>
			<if test="po.companyId != null">
				and u.company_id = #{po.companyId}
			</if>
			<if test="1==1">
				and u.type = 4
			</if>
			<if test="companyIds != null">
				and u.company_id in
				<foreach item="companyId" collection="companyIds" separator="," open="(" close=")">
					#{companyId}
				</foreach>
			</if>
		</where>) u,
		(SELECT distinct user_id FROM u_user_platform where platform_id = #{po.platformId}) up
		where up.user_id = ue.id and ue.id = u.id
		<if test="page != null">
			limit #{page.limitStart},#{page.pageSize}
		</if>) us
		where ue.id = u.id and u.id = us.id
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY u.company_id
			</otherwise>
		</choose>
	</select> -->
	<select id="findByUserIds" resultMap="userExtendCondition">
		select
				ue.id,
				ue.name ,
				u.mail ,
				c.company_name,
				ue.member_code
			from u_user u
			LEFT JOIN u_user_extend ue on u.id = ue.id
			LEFT JOIN u_company c ON u.company_id = c.id
			where u.id in
			<foreach collection="userIds" item="userId" open="(" close=")" separator=",">
				#{userId}
			</foreach>
	</select>

	<select id="countuserExtendAllOfPage" resultType="java.lang.Integer">
		SELECT
		count(u.id) cnt
		FROM
		(SELECT
		ue.id
		FROM u_user_extend ue
		<where>
			<if test="po.name != null">
				and ue.name like concat('%',#{po.name},'%')
			</if>
			<if test="po.sex != null">
				and ue.sex = #{po.sex}
			</if>
			<if test="po.status != null">
				and ue.status = #{po.status}
			</if>
			<if test="po.accountStatus != null">
				and ue.account_status = #{po.accountStatus}
			</if>
			<if test="po.memberCode != null">
				and ue.member_code like concat('%',#{po.memberCode},'%')
			</if>
			<if test="po.birthday != null">
				and date_format(ue.birthday,'%y-%m-%d') = date_format(#{po.birthday},'%y-%m-%d')
			</if>
			<if test="po.isAdministrator != null">
				and ue.is_administrator = #{po.isAdministrator}
			</if>
			<if test="po.channelId != null">
				and ue.channel_id = #{po.channelId}
			</if>
			<if test="po.campaignCode != null">
				and ue.campaign_code like concat('%',#{po.campaignCode},'%')
			</if>
			<if test="po.entryStartTime!=null">
				and ue.create_time >=#{po.entryStartTime}
			</if>
			<if test="po.entryFinishTime!=null">
				and #{po.entryFinishTime}  >= ue.create_time
			</if>
		</where>) ue,
		(SELECT
		u.id
		FROM u_user u
		<where>
			<if test="po.companyId != null">
				and u.company_id = #{po.companyId}
			</if>
			<if test="1==1">
				and u.type = 4
			</if>
			<if test="po.isAvailable != null">
				and u.is_available = #{po.isAvailable}
			</if>
			<if test="po.mail != null">
				and u.mail like concat('%',#{po.mail},'%')
			</if>
			<if test="po.mobile != null">
				and u.mobile like concat('%',#{po.mobile},'%')
			</if>
			<if test="companyIds != null">
				and u.company_id in
				<foreach item="companyId" collection="companyIds" separator="," open="(" close=")">
					#{companyId}
				</foreach>
			</if>
		</where>) u,
		(SELECT distinct user_id FROM u_user_platform where platform_id = #{po.platformId}) up
		where up.user_id = ue.id and ue.id = u.id

	</select>

	<sql id="userExtendAllByCompanyOfPageSql">
		FROM u_user_extend ue
		LEFT JOIN u_user u ON
		ue.id =
		u.id
		LEFT JOIN u_user_welfare uw
		ON u.id = uw.user_id
		LEFT JOIN u_company
		c
		ON u.company_id = c.id
		LEFT JOIN u_department d
		ON uw.department_id = d.id
		<where>
			<if test="companyList != null">
				and u.company_id in
				<foreach item="companyId" collection="companyList" separator="," open="(" close=")">
					#{companyId}
				</foreach>
			</if>
		</where>
	</sql>

	<select id="userExtendAllByCompanyOfPage" resultMap="userExtendCondition">
		SELECT

		ue.id,
		ue.sex,
		ue.`name`,
		ue.birthday,
		u.mobile,
		ue.member_code,
		ue.status,
		ue.account_status,
		ue.is_deleted,
		ue.channel_id,
		u.mail,
		u.is_available,
		d.department_name,
		c.company_name,
		u.quit_time,
		ue.invalid_time,
		ue.channel_source,
		ue.id_card_no
		<include refid="userExtendAllByCompanyOfPageSql"/>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY u.company_id
			</otherwise>
		</choose>
		<if test="page != null">
			limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>

	<select id="countUserExtendAllByCompanyOfPage" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		<include refid="userExtendAllByCompanyOfPageSql"/>
	</select>

	<select id="userAll" resultMap="userExtendCondition">
		SELECT
		u.id,
		u.mail,
		u.is_available,
		ue.`name`,
		ue.sex,
		ue.birthday,
		ue.member_code,
		u.mobile,
		uw.entry_time,
		ue.account_status,
		d.department_name,
		u.import_records_id,
		ue.channel_source,
		ue.id_card_no
		FROM u_user u
		LEFT JOIN u_user_extend ue on
		ue.id = u.id
		LEFT JOIN
		u_user_welfare uw on uw.user_id = u.id
		LEFT JOIN
		u_department d on d.id
		= uw.department_id
		LEFT JOIN u_user_platform up
		on up.user_id = u.id
		<where>
			<if test="true">
				and u.is_deleted = 0
			</if>
			<if test="po.mail != null">
				and u.mail = #{po.mail}
			</if>
			<if test="po.companyId != null">
				and u.company_id = #{po.companyId}
			</if>
			<if test="po.name != null">
				and ue.name = #{po.name}
			</if>
			<if test="po.memberCode != null">
				and ue.member_code = #{po.memberCode}
			</if>
			<if test="po.sex != null">
				and ue.sex = #{po.sex}
			</if>
			<if test="po.departmentId != null">
				and uw.department_id = #{po.departmentId}
			</if>
			<if test="po.birthdayStartTime != null">
				and ue.birthday > #{po.birthdayStartTime}
			</if>
			<if test="po.birthdayFinishTime != null">
				and #{po.birthdayFinishTime} > ue.birthday
			</if>
			<if test="po.entryStartTime != null">
				and uw.entry_time > #{po.entryStartTime}
			</if>
			<if test="po.entryFinishTime != null">
				and #{po.entryFinishTime} > uw.entry_time
			</if>
			<if test="po.platformId != null">
				and up.platform_id = #{po.platformId}
			</if>
		</where>
		ORDER BY uw.entry_time desc,u.id
	</select>

	<select id="findAlluser" resultMap="userExtendCondition">
		SELECT
		u.id,
		ue.`name`,
		ue.sex,
		ue.birthday,
		ue.mobile,
		uw.entry_time,
		u.mail,
		d.department_name
		FROM u_user u
		LEFT JOIN u_user_extend ue on
		ue.id = u.id
		LEFT JOIN u_user_welfare uw on uw.user_id = u.id
		LEFT JOIN u_department d on d.id = uw.department_id
		LEFT JOIN u_user_platform up on u.id = up.user_id
		<where>
			<if test="true">
				and u.is_deleted = 0
			</if>
			<if test="true">
				and ue.account_status = 0
			</if>
			<if test="po.companyId != null">
				and u.company_id = #{po.companyId}
			</if>
			<if test="po.name != null">
				and ue.name = #{po.name}
			</if>
			<if test="po.memberCode != null">
				and ue.member_code = #{po.memberCode}
			</if>
			<if test="po.sex != null">
				and ue.sex = #{po.sex}
			</if>
			<if test="po.departmentId != null">
				and uw.department_id = #{po.departmentId}
			</if>
			<if test="po.birthdayStartTime != null">
				and ue.birthday > #{po.birthdayStartTime}
			</if>
			<if test="po.birthdayFinishTime != null">
				and #{po.birthdayFinishTime} > ue.birthday
			</if>
			<if test="po.entryStartTime != null">
				and uw.entry_time > #{po.entryStartTime}
			</if>
			<if test="po.entryFinishTime != null">
				and #{po.entryFinishTime} > uw.entry_time
			</if>
			<if test="po.mail != null">
				and u.mail = #{po.mail}
			</if>
			<if test="po.platformId != null">
				and up.platform_id = #{po.platformId}
			</if>
		</where>
		ORDER BY uw.entry_time desc,u.id
	</select>

	<select id="userAdminAll" resultMap="userExtend">
		SELECT
		ue.id,
		(SELECT
		u.login_name from u_user u WHERE u.id = ue.id) name
		FROM u_user_extend
		ue
		WHERE ue.is_administrator = 1 and ue.account_status = 0
	</select>

	<select id="userAdminCompany" resultMap="userExtendCondition">
		SELECT
			ue.id,
			u.login_name as name,
			u.mail
			FROM u_user_extend ue
				left join u_user u on u.id = ue.id
			WHERE ue.is_administrator = 1 and ue.account_status = 0 and u.company_id = #{companyId}
	</select>
	<select id="userByMobile" resultMap="userExtendCondition">
		SELECT
		ue.id,
		ue.nickname,
		ue.head_pic_url,
		ue.name,
		ue.regtime,
		ue.status,
		u.mobile,
		u.mail,
		ue.qq,
		ue.remark,
		ue.weixin,
		u.company_id,
		c.company_name,
		ue.regtime,
		ue.account_status,
		ue.id_card_no
		FROM u_user u,u_user_extend ue,u_user_platform up,u_company c
		WHERE u.id = ue.id and up.user_id = u.id and u.id = up.user_id and u.company_id = c.id
		and account_status = 0
		and u.mobile = #{mobile} and up.platform_id = #{platformId}
		ORDER BY ue.regtime desc,u.id
	</select>

	<select id="queryUserByCondition" resultMap="userExtend">
		select
		ue.*,
		u.mail,
		u.is_available,
		u.company_id
		from
		u_user_extend ue
		left join u_user u on u.id = ue.id
		<where>
			<if test="po.mail != null">
				and u.mail = #{po.mail}
			</if>
			<if test="po.isAvailable != null">
				and u.is_available = #{po.isAvailable}
			</if>
			<if test="po.accountStatus != null">
				and ue.account_status = #{po.accountStatus}
			</if>
			<if test="po.companyId != null">
				and u.company_id = #{po.companyId}
			</if>
			<if test="po.isDeleted != null">
				and u.is_deleted = #{po.isDeleted}
			</if>
		</where>
	</select>

	<select id="findUserIdByIsAdministrator" resultType="java.lang.Long">
		SELECT
		id
		FROM u_user_extend
		WHERE account_status = 0 and is_administrator = #{isAdministrator}
	</select>

	<select id="findUserExtendCByUserIds" resultMap="userExtendCondition">
		SELECT
		ue.id,
		ue.sex,
		ue.`name`,
		ue.birthday,
		u.mobile,
		ue.member_code,
		ue.status,
		ue.account_status,
		ue.is_deleted,
		ue.channel_id,
		u.mail,
		u.is_available,
		u.quit_time,
		u.company_id,
		ue.invalid_time,
		ue.id_card_no
		FROM u_user_extend ue
		LEFT JOIN u_user u ON ue.id = u.id
		where ue.id in
		<foreach collection="ids" item="id" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</select>

	<select id="findUserLists" resultType="java.lang.Long">
		SELECT
		a.id
		FROM
		u_user a
		LEFT JOIN u_user_extend b ON  a.id=b.id
		<where>
		<if test="name != null">
			and b.name LIKE concat('%',#{name},'%')
		</if>
		<if test="mail != null">
			and a.mail LIKE concat('%',#{mail},'%')
		</if>
		<if test="mobile != null">
			and a.mobile LIKE concat('%',#{mobile},'%')
		</if>
		<if test="birthday != null">
			and b.birthday = #{birthday}
		</if>
		<if test="sex != null">
			and b.sex = #{sex}
		</if>
		<if test="companyId != null">
			and a.company_id IN
			<foreach collection="companyId" item="cId" open="(" separator="," close=")">
				#{cId}
			</foreach>
		</if>
		</where>

	</select>


	<select id="findUserList" resultType="java.lang.Long">
		SELECT
		a.id
		FROM
		u_user a
		LEFT JOIN u_user_extend b ON  a.id=b.id
		<where>
			<if test="name != null">
				and b.name LIKE concat('%',#{name},'%')
			</if>
			<if test="mail != null">
				and a.mail LIKE concat('%',#{mail},'%')
			</if>
			<if test="mobile != null">
				and a.mobile LIKE concat('%',#{mobile},'%')
			</if>
			<if test="birthday != null">
				and b.birthday = #{birthday}
			</if>
			<if test="sex != null">
				and b.sex = #{sex}
			</if>

		</where>
	</select>

	<select id="findAdminUserByManage" resultMap="userExtend">
		SELECT
		ue.id,
		ue.name
		FROM u_user u,u_user_extend ue,u_user_platform up
		WHERE u.id = ue.id and up.user_id = u.id and u.id = up.user_id
		and account_status = 0 and ue.is_administrator = 1
		and u.mobile = #{mobile} and up.platform_id = #{platformId}
	</select>




	<select id="getUserStoreAdminAll" resultMap="userExtendCondition">
		SELECT
		b.mail,
		b.is_available,
		b.quit_time,
		b.company_id,
		b.mobile,
		<include refid="userStoreExtendColumns" />
		from u_user_extend a,u_user b,
		(SELECT user_id from u_store_admin WHERE store_id = #{storeId}) c,
		(SELECT user_id from u_user_platform WHERE platform_id = #{po.platformId}) d
		<where> a.id = b.id and a.id = c.user_id and a.id = d.user_id
		and b.company_id =#{po.companyId} and a.is_administrator = 1
			<if test="po.accountStatus != null">
				and a.account_status = #{po.accountStatus}
			</if>
			<if test="po.mobile != null">
				and b.mobile like concat('%',#{po.mobile},'%')
			</if>
		</where>
	</select>

	<select id="getUserAdminAll" resultMap="userExtendCondition">
		SELECT
		b.mail,
		b.is_available,
		b.quit_time,
		b.company_id,
		b.mobile,
		<include refid="userStoreExtendColumns" />
		from u_user_extend a,u_user b,
		(SELECT user_id from u_user_platform WHERE platform_id = #{po.platformId}) d
		<where> a.id = b.id and a.id = d.user_id and  b.company_id =#{po.companyId}
		and a.is_administrator = 1
			<if test="po.accountStatus != null">
				and a.account_status = #{po.accountStatus}
			</if>
			<if test="po.mobile != null">
				and b.mobile like concat('%',#{po.mobile},'%')
			</if>
		</where>
	</select>

	<select id="findUserSumByStoreId" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		from u_user_extend ue, u_user_platform up
		WHERE
		ue.id = up.user_id
		and ue.register_store_id = #{storeId}
		and up.platform_id = #{platformId}
	</select>

	<select id="findCurrentMonthUserSumByStoreId" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		from u_user_extend ue, u_user_platform up
		WHERE
		ue.id = up.user_id
		and DATE_FORMAT(ue.create_time,'%Y-%m')=DATE_FORMAT(#{date},'%Y-%m')
		and ue.register_store_id = #{storeId}
		and up.platform_id = #{platformId}
	</select>

	<select id="findCurrentDayUserSumByStoreId" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		from u_user_extend ue, u_user_platform up
		WHERE
		ue.id = up.user_id
		and DATE_FORMAT(ue.create_time,'%Y-%m-%d')=DATE_FORMAT(#{date},'%Y-%m-%d')
		and ue.register_store_id = #{storeId}
		and up.platform_id = #{platformId}
	</select>

</mapper>
