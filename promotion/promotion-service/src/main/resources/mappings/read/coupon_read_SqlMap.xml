<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.egeo.components.promotion.dao.read.CouponReadDAO">
	<resultMap type="com.egeo.components.promotion.po.CouponPO" id="couponMap">
		<result property="id" column="id" />
		<result property="couponCode" column="coupon_code" />
		<result property="title" column="title" />
		<result property="couponType" column="coupon_type" />
		<result property="discountAmount" column="discount_amount" />
		<result property="triggerAmount" column="trigger_amount" />
		<result property="goodsType" column="goods_type" />
		<result property="goodsId" column="goods_id" />
		<result property="usageCount" column="usage_count" />
		<result property="jumpType" column="jump_type" />
		<result property="iconUrl" column="icon_url" />
		<result property="detail" column="detail" />
		<result property="updateUser" column="update_user" />
		<result property="isDelete" column="is_delete" />
		<result property="createTime" column="create_time" />
		<result property="updateTime" column="update_time" />
		<result property="platformId" column="platform_id" />
	</resultMap>

	<sql id="couponColumns">
		id,
		coupon_code,
		title,
		coupon_type,
		discount_amount,
		trigger_amount,
		goods_type,
		goods_id,
		usage_count,
		jump_type,
		icon_url,
		detail,
		update_user,
		is_delete,
		create_time,
		update_time,
		platform_id
	</sql>

	<select id="findById" parameterType="com.egeo.components.promotion.po.CouponPO" resultMap="couponMap">
		SELECT
		<include refid="couponColumns" />
		FROM coupon
		WHERE id = #{po.id}
	</select>

	<select id="findOfPage" resultMap="couponMap">
		SELECT
		<include refid="couponColumns" />
		FROM coupon
		<where>
			<if test="po.couponCode != null">
				and coupon_code = #{po.couponCode}
			</if>
			<if test="po.title != null">
				and title = #{po.title}
			</if>
			<if test="po.couponType != null">
				and coupon_type = #{po.couponType}
			</if>
			<if test="po.discountAmount != null">
				and discount_amount = #{po.discountAmount}
			</if>
			<if test="po.triggerAmount != null">
				and trigger_amount = #{po.triggerAmount}
			</if>
			<if test="po.goodsType != null">
				and goods_type = #{po.goodsType}
			</if>
			<if test="po.goodsId != null">
				and goods_id = #{po.goodsId}
			</if>
			<if test="po.usageCount != null">
				and usage_count = #{po.usageCount}
			</if>
			<if test="po.jumpType != null">
				and jump_type = #{po.jumpType}
			</if>
			<if test="po.iconUrl != null">
				and icon_url = #{po.iconUrl}
			</if>
			<if test="po.detail != null">
				and detail = #{po.detail}
			</if>
			<if test="po.updateUser != null">
				and update_user = #{po.updateUser}
			</if>
			<if test="po.isDelete != null">
				and is_delete = #{po.isDelete}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>		
			<otherwise>
				ORDER BY id desc		
			</otherwise>
		</choose>
		<if test="page != null">
		limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>
	
	<sql id="findOfPageByBlurrySql">
		FROM coupon c
			<where>
				<if test="po.couponCode != null">
					and coupon_code = #{po.couponCode}
				</if>
				<if test="po.couponType != null">
					and coupon_type = #{po.couponType}  
				</if>
				<if test="po.goodsType != null">
					and goods_type = #{po.goodsType}
				</if>
				<if test="po.goodsId != null">
					and goods_id = #{po.goodsId}
				</if>
				<if test="po.isDelete != null">
					and is_delete = #{po.isDelete}
				</if>
				<if test="po.title != null">
					and title like concat('%',#{po.title},'%')
				</if>
				<if test="couponIdList != null">
					id in 
					<foreach item="id" collection="couponIdList" separator="," open="(" close=")">
					#{id}
					</foreach>
				</if>
				<if test="po.platformId != null">
					and platform_id = #{po.platformId}
				</if>
				<if test="po.storeName != null">
					and EXISTS (
						select 1 from coupon_store st where c.id = st.coupon_id
							<if test="po.storeList != null">
								and st.store_id in
								<foreach item="storeId" collection="po.storeList" separator="," open="(" close=")">
									#{storeId}
								</foreach>
							</if>
					)
				</if>
			</where>
	</sql>
	
	<select id="countOfPageByBlurry" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		<include refid="findOfPageByBlurrySql"/>
	</select>
	
	<select id="findOfPageByBlurry" resultMap="couponMap">
		SELECT
		<include refid="couponColumns" />
		<include refid="findOfPageByBlurrySql"/>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>		
			<otherwise>
				ORDER BY id desc		
			</otherwise>
		</choose>
		<if test="page != null">
		limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>
	
	<select id="countOfPage" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		FROM coupon
		<where>
			<if test="po.couponCode != null">
				and coupon_code = #{po.couponCode}
			</if>
			<if test="po.title != null">
				and title = #{po.title}
			</if>
			<if test="po.couponType != null">
				and coupon_type = #{po.couponType}
			</if>
			<if test="po.discountAmount != null">
				and discount_amount = #{po.discountAmount}
			</if>
			<if test="po.triggerAmount != null">
				and trigger_amount = #{po.triggerAmount}
			</if>
			<if test="po.goodsType != null">
				and goods_type = #{po.goodsType}
			</if>
			<if test="po.goodsId != null">
				and goods_id = #{po.goodsId}
			</if>
			<if test="po.usageCount != null">
				and usage_count = #{po.usageCount}
			</if>
			<if test="po.jumpType != null">
				and jump_type = #{po.jumpType}
			</if>
			<if test="po.iconUrl != null">
				and icon_url = #{po.iconUrl}
			</if>
			<if test="po.detail != null">
				and detail = #{po.detail}
			</if>
			<if test="po.updateUser != null">
				and update_user = #{po.updateUser}
			</if>
			<if test="po.isDelete != null">
				and is_delete = #{po.isDelete}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
		</where>
	</select>
	
	<select id="findAll" resultMap="couponMap">
		SELECT
		<include refid="couponColumns" />
		FROM coupon
		<where>
			<if test="po.couponCode != null">
				and coupon_code = #{po.couponCode}
			</if>
			<if test="po.title != null">
				and title = #{po.title}
			</if>
			<if test="po.couponType != null">
				and coupon_type = #{po.couponType}
			</if>
			<if test="po.discountAmount != null">
				and discount_amount = #{po.discountAmount}
			</if>
			<if test="po.triggerAmount != null">
				and trigger_amount = #{po.triggerAmount}
			</if>
			<if test="po.goodsType != null">
				and goods_type = #{po.goodsType}
			</if>
			<if test="po.goodsId != null">
				and goods_id = #{po.goodsId}
			</if>
			<if test="po.usageCount != null">
				and usage_count = #{po.usageCount}
			</if>
			<if test="po.jumpType != null">
				and jump_type = #{po.jumpType}
			</if>
			<if test="po.iconUrl != null">
				and icon_url = #{po.iconUrl}
			</if>
			<if test="po.detail != null">
				and detail = #{po.detail}
			</if>
			<if test="po.updateUser != null">
				and update_user = #{po.updateUser}
			</if>
			<if test="po.isDelete != null">
				and is_delete = #{po.isDelete}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>			
			<otherwise>
				ORDER BY id desc		
			</otherwise>
		</choose>
	</select>
	
	<select id="findCouponByCouponGroupId" resultMap="couponMap">
		SELECT
		<include refid="couponColumns" />
		FROM coupon c,(SELECT coupon_id from coupon_group_rel WHERE coupon_group_id = #{couponRelId}) cgr
		WHERE cgr.coupon_id = c.id
	</select>
</mapper>
	