<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.egeo.components.promotion.dao.read.CouponBatchReadDAO">
	<resultMap type="com.egeo.components.promotion.po.CouponBatchPO" id="couponBatchMap">
		<result property="id" column="id" />
		<result property="couponBatchCode" column="coupon_batch_code" />
		<result property="couponRelType" column="coupon_rel_type" />
		<result property="couponRelId" column="coupon_rel_id" />
		<result property="grantType" column="grant_type" />
		<result property="getType" column="get_type" />
		<result property="chooseWay" column="choose_way" />
		<result property="companyId" column="company_id" />
		<result property="grantCount" column="grant_count" />
		<result property="isRepeat" column="is_repeat" />
		<result property="isDisplay" column="is_display" />
		<result property="receiveStartTime" column="receive_start_time" />
		<result property="receiveEndTime" column="receive_end_time" />
		<result property="effectStartTime" column="effect_start_time" />
		<result property="effectEndTime" column="effect_end_time" />
		<result property="effectDays" column="effect_days" />
		<result property="isEffect" column="is_effect" />
		<result property="creator" column="creator" />
		<result property="createTime" column="create_time" />
		<result property="updateTime" column="update_time" />
		<result property="platformId" column="platform_id" />
		<result property="linkableId" column="linkable_id" />
		<result property="couponBatchName" column="coupon_batch_name" />
	</resultMap>
	
	<resultMap type="com.egeo.components.promotion.condition.CouponBatchCondition" 
		extends="couponBatchMap" id="couponBatchConditionMap">
		<result property="title" column="title" />
		<result property="couponId" column="coupon_id" />
		<result property="couponType" column="coupon_type" />
		<result property="detail" column="detail" />
		<result property="discountAmount" column="discount_amount" />
		<result property="triggerAmount" column="trigger_amount" />
	</resultMap>

	<sql id="couponBatchColumns">
		id,
		coupon_batch_code,
		coupon_rel_type,
		coupon_rel_id,
		grant_type,
		get_type,
		choose_way,
		company_id,
		grant_count,
		is_repeat,
		is_display,
		receive_start_time,
		receive_end_time,
		effect_start_time,
		effect_end_time,
		effect_days,
		is_effect,
		creator,
		create_time,
		update_time,
		platform_id,
		linkable_id,
		coupon_batch_name
	</sql>

	<select id="findById" parameterType="com.egeo.components.promotion.po.CouponBatchPO" resultMap="couponBatchMap">
		SELECT
		<include refid="couponBatchColumns" />
		FROM coupon_batch
		WHERE id = #{po.id}
	</select>

	<select id="findOfPage" resultMap="couponBatchMap">
		SELECT
		<include refid="couponBatchColumns" />
		FROM coupon_batch
		<where>
			<if test="po.couponBatchCode != null">
				and coupon_batch_code = #{po.couponBatchCode}
			</if>
			<if test="po.couponRelType != null">
				and coupon_rel_type = #{po.couponRelType}
			</if>
			<if test="po.couponRelId != null">
				and coupon_rel_id = #{po.couponRelId}
			</if>
			<if test="po.grantType != null">
				and grant_type = #{po.grantType}
			</if>
			<if test="po.getType != null">
				and get_type = #{po.getType}
			</if>
			<if test="po.chooseWay != null">
				and choose_way = #{po.chooseWay}
			</if>
			<if test="po.companyId != null">
				and company_id = #{po.companyId}
			</if>
			<if test="po.grantCount != null">
				and grant_count = #{po.grantCount}
			</if>
			<if test="po.isRepeat != null">
				and is_repeat = #{po.isRepeat}
			</if>
			<if test="po.isDisplay != null">
				and is_display = #{po.isDisplay}
			</if>
			<if test="po.receiveStartTime != null">
				and receive_start_time = #{po.receiveStartTime}
			</if>
			<if test="po.receiveEndTime != null">
				and receive_end_time = #{po.receiveEndTime}
			</if>
			<if test="po.effectStartTime != null">
				and effect_start_time = #{po.effectStartTime}
			</if>
			<if test="po.effectEndTime != null">
				and effect_end_time = #{po.effectEndTime}
			</if>
			<if test="po.effectDays != null">
				and effect_days = #{po.effectDays}
			</if>
			<if test="po.isEffect != null">
				and is_effect = #{po.isEffect}
			</if>
			<if test="po.creator != null">
				and creator = #{po.creator}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
			<if test="po.couponBatchName != null">
				and coupon_batch_name = #{po.couponBatchName}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>		
			<otherwise>
				ORDER BY id desc		
			</otherwise>
		</choose>
		<if test="page != null">
		limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>
	
	<select id="countOfPage" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		FROM coupon_batch
		<where>
			<if test="po.couponBatchCode != null">
				and coupon_batch_code = #{po.couponBatchCode}
			</if>
			<if test="po.couponRelType != null">
				and coupon_rel_type = #{po.couponRelType}
			</if>
			<if test="po.couponRelId != null">
				and coupon_rel_id = #{po.couponRelId}
			</if>
			<if test="po.grantType != null">
				and grant_type = #{po.grantType}
			</if>
			<if test="po.getType != null">
				and get_type = #{po.getType}
			</if>
			<if test="po.chooseWay != null">
				and choose_way = #{po.chooseWay}
			</if>
			<if test="po.companyId != null">
				and company_id = #{po.companyId}
			</if>
			<if test="po.grantCount != null">
				and grant_count = #{po.grantCount}
			</if>
			<if test="po.isRepeat != null">
				and is_repeat = #{po.isRepeat}
			</if>
			<if test="po.isDisplay != null">
				and is_display = #{po.isDisplay}
			</if>
			<if test="po.receiveStartTime != null">
				and receive_start_time = #{po.receiveStartTime}
			</if>
			<if test="po.receiveEndTime != null">
				and receive_end_time = #{po.receiveEndTime}
			</if>
			<if test="po.effectStartTime != null">
				and effect_start_time = #{po.effectStartTime}
			</if>
			<if test="po.effectEndTime != null">
				and effect_end_time = #{po.effectEndTime}
			</if>
			<if test="po.effectDays != null">
				and effect_days = #{po.effectDays}
			</if>
			<if test="po.isEffect != null">
				and is_effect = #{po.isEffect}
			</if>
			<if test="po.creator != null">
				and creator = #{po.creator}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
			<if test="po.couponBatchName != null">
				and coupon_batch_name = #{po.couponBatchName}
			</if>
		</where>
	</select>
	
	<sql id="findOfPageByBlurrySql">
		FROM 
		coupon_batch cb 
		LEFT JOIN coupon c on coupon_rel_type = 0 and c.id = cb.coupon_rel_id 
		LEFT JOIN coupon_group cg on coupon_rel_type = 1 and cg.id = cb.coupon_rel_id 
		<where>
			<if test="po.grantType != null">
				and cb.grant_type = #{po.grantType}
			</if>
			<if test="po.getType != null">
				and cb.get_type = #{po.getType}
			</if>
			<if test="po.isDisplay != null">
				and cb.is_display = #{po.isDisplay}
			</if>
			<if test="po.couponBatchCode != null">
				and cb.coupon_batch_code = #{po.couponBatchCode}  
			</if>
			<if test="po.receiveStartTime != null">
				and cb.receive_start_time &gt;= #{po.receiveStartTime}
			</if>
			<if test="po.receiveEndTime != null">
				and cb.receive_end_time &lt;= #{po.receiveEndTime}
			</if>
			<if test="po.effectStartTime != null">
				and (cb.effect_start_time &gt;= #{po.effectStartTime} or cb.effect_start_time is null)
				and cb.effect_days = -1
			</if>
			<if test="po.effectEndTime != null">
				and (cb.effect_end_time &lt;= #{po.effectEndTime} or cb.effect_end_time is null) 
				and cb.effect_days = -1
			</if>
			<if test="title != null">
				and (c.title like concat('%',#{title},'%') or cg.group_name like concat('%',#{title},'%'))
			</if>
			<if test="po.platformId != null">
				and cb.platform_id = #{po.platformId}
			</if>
			<if test="po.couponBatchName != null">
				and coupon_batch_name like concat('%', #{po.couponBatchName},'%')
			</if>
			<if test="po.couponRelType != null">
				and cb.coupon_rel_type = #{po.couponRelType}
			</if>
			<if test="po.isEffect != null">
				and cb.is_effect = #{po.isEffect}
			</if>
		</where>
	</sql>
	
	<select id="findOfPageByBlurry" resultMap="couponBatchConditionMap">
		SELECT 
		cb.*,
		IFNULL(c.title,cg.group_name) title 
		<include refid="findOfPageByBlurrySql"/>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>		
			<otherwise>
				ORDER BY cb.id desc		
			</otherwise>
		</choose>
		<if test="page != null">
			limit #{page.limitStart},#{page.pageSize} 
		</if>
	</select>
	
	<select id="countOfPageByBlurry" resultType="java.lang.Integer">
		SELECT
		count(1) cnt 
		<include refid="findOfPageByBlurrySql"/>
	</select>
	
	<select id="findAll" resultMap="couponBatchMap">
		SELECT
		<include refid="couponBatchColumns" />
		FROM coupon_batch
		<where>
			<if test="po.couponBatchCode != null">
				and coupon_batch_code = #{po.couponBatchCode}
			</if>
			<if test="po.couponBatchName != null">
				and coupon_batch_name = #{po.couponBatchName}
			</if>
			<if test="po.couponRelType != null">
				and coupon_rel_type = #{po.couponRelType}
			</if>
			<if test="po.couponRelId != null">
				and coupon_rel_id = #{po.couponRelId}
			</if>
			<if test="couponIdList !=null and couponIdList.size() > 0 ">
				AND coupon_rel_id IN
				<foreach  collection="couponIdList"  item="couponId"  open="("  separator=","   close=")">
					#{couponId}
				</foreach>
			</if>
			<if test="po.grantType != null">
				and grant_type = #{po.grantType}
			</if>
			<if test="po.getType != null">
				and get_type = #{po.getType}
			</if>
			<if test="po.chooseWay != null">
				and choose_way = #{po.chooseWay}
			</if>
			<if test="po.companyId != null">
				and company_id = #{po.companyId}
			</if>
			<if test="po.grantCount != null">
				and grant_count = #{po.grantCount}
			</if>
			<if test="po.isRepeat != null">
				and is_repeat = #{po.isRepeat}
			</if>
			<if test="po.isDisplay != null">
				and is_display = #{po.isDisplay}
			</if>
			<if test="po.receiveStartTime != null">
				and receive_start_time = #{po.receiveStartTime}
			</if>
			<if test="po.receiveEndTime != null">
				and receive_end_time = #{po.receiveEndTime}
			</if>
			<if test="po.effectStartTime != null">
				and effect_start_time = #{po.effectStartTime}
			</if>
			<if test="po.effectEndTime != null">
				and effect_end_time = #{po.effectEndTime}
			</if>
			<if test="po.effectDays != null">
				and effect_days = #{po.effectDays}
			</if>
			<if test="po.isEffect != null">
				and is_effect = #{po.isEffect}
			</if>
			<if test="po.creator != null">
				and creator = #{po.creator}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>			
			<otherwise>
				ORDER BY id desc		
			</otherwise>
		</choose>
	</select>

	<select id="findCouponBatchByCouponIds" resultMap="couponBatchMap">
		SELECT
		<include refid="couponBatchColumns" />
		FROM coupon_batch
		<where>
			<if test="po.couponBatchCode != null">
				and coupon_batch_code = #{po.couponBatchCode}
			</if>
			<if test="po.couponBatchName != null">
				and coupon_batch_name = #{po.couponBatchName}
			</if>
			<if test="po.couponRelType != null">
				and coupon_rel_type = #{po.couponRelType}
			</if>
			<if test="po.couponRelId != null">
				and coupon_rel_id = #{po.couponRelId}
			</if>
			<if test="po.grantType != null">
				and grant_type = #{po.grantType}
			</if>
			<if test="po.getType != null">
				and get_type = #{po.getType}
			</if>
			<if test="po.chooseWay != null">
				and choose_way = #{po.chooseWay}
			</if>
			<if test="po.companyId != null">
				and company_id = #{po.companyId}
			</if>
			<if test="po.grantCount != null">
				and grant_count = #{po.grantCount}
			</if>
			<if test="po.isRepeat != null">
				and is_repeat = #{po.isRepeat}
			</if>
			<if test="po.isDisplay != null">
				and is_display = #{po.isDisplay}
			</if>
			<if test="po.receiveStartTime != null">
				and receive_start_time = #{po.receiveStartTime}
			</if>
			<if test="po.receiveEndTime != null">
				and receive_end_time = #{po.receiveEndTime}
			</if>
			<if test="po.effectStartTime != null">
				and effect_start_time = #{po.effectStartTime}
			</if>
			<if test="po.effectEndTime != null">
				and effect_end_time = #{po.effectEndTime}
			</if>
			<if test="po.effectDays != null">
				and effect_days = #{po.effectDays}
			</if>
			<if test="po.isEffect != null">
				and is_effect = #{po.isEffect}
			</if>
			<if test="po.creator != null">
				and creator = #{po.creator}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
			<if test="couponIdList !=null and couponIdList.size() > 0 ">
				AND coupon_rel_id IN
				<foreach  collection="couponIdList"  item="couponId"  open="("  separator=","   close=")">
					#{couponId}
				</foreach>
			</if>
			<if test="key.currentDate != null">
				and receive_start_time &lt; #{key.currentDate} and receive_end_time &gt; #{key.currentDate}
			</if>
		</where>
	</select>
	
	<select id="findRegisterCouponBatchByCouponId" resultMap="couponBatchConditionMap">
		select 
		cb.id,
		cb.coupon_batch_code,
		cb.coupon_rel_type,
		cb.coupon_rel_id,
		cb.grant_type,
		cb.get_type,
		cb.choose_way,
		cb.company_id,
		cb.grant_count,
		cb.is_repeat,
		cb.is_display,
		cb.receive_start_time,
		cb.receive_end_time,
		cb.effect_start_time,
		cb.effect_end_time,
		cb.effect_days,
		cb.is_effect,
		cb.creator,
		cb.create_time,
		cb.update_time,
		cb.platform_id,
		cb.coupon_rel_id coupon_id,
		cb.coupon_batch_name
		from coupon_batch cb
		where cb.coupon_rel_type = 0 and cb.is_effect = 0 
			and cb.grant_type=1 and cb.get_type = 1
			and cb.receive_start_time <![CDATA[<=]]> NOW() and cb.receive_end_time <![CDATA[>=]]> NOW()
			and cb.platform_id = #{platformId}
			and cb.coupon_rel_id in 
			<foreach  collection="couponIdList"  item="couponId"  open="("  separator=","   close=")">
				#{couponId}
			</foreach>
	</select>
	
	<select id="findRegisterCouponBatchByCouponGroup" resultMap="couponBatchConditionMap">
		select 
		cb.id,
		cb.coupon_batch_code,
		cb.coupon_rel_type,
		cb.coupon_rel_id,
		cb.grant_type,
		cb.get_type,
		cb.choose_way,
		cb.company_id,
		cb.grant_count,
		cb.is_repeat,
		cb.is_display,
		cb.receive_start_time,
		cb.receive_end_time,
		cb.effect_start_time,
		cb.effect_end_time,
		cb.effect_days,
		cb.is_effect,
		cb.creator,
		cb.create_time,
		cb.update_time,
		cb.platform_id,
		cb.coupon_batch_name,
		cgr.coupon_id
		from coupon_batch cb,coupon_group_rel cgr 
		where cb.coupon_rel_id = cgr.coupon_group_id and coupon_rel_type = 1 and cb.is_effect = 0 
			and cb.grant_type=1 and cb.get_type = 1
			and cb.receive_start_time <![CDATA[<=]]> NOW() and cb.receive_end_time <![CDATA[>=]]> NOW()
			and cb.platform_id = #{platformId} 
			and cgr.coupon_id in 
			<foreach  collection="couponIdList"  item="couponId"  open="("  separator=","   close=")">
				#{couponId}
			</foreach>
	</select>

	<select id="findCouponBatchCount" resultType="java.lang.Long">
		SELECT
		count(1)
		FROM coupon_batch
		<where>
			<if test="po.id != null">
				and id = #{po.id}
			</if>
			<if test="po.couponBatchCode != null">
				and coupon_batch_code = #{po.couponBatchCode}
			</if>
			<if test="po.couponRelType != null">
				and coupon_rel_type = #{po.couponRelType}
			</if>
			<if test="po.couponRelId != null">
				and coupon_rel_id = #{po.couponRelId}
			</if>
			<if test="po.grantType != null">
				and grant_type = #{po.grantType}
			</if>
			<if test="po.getType != null">
				and get_type = #{po.getType}
			</if>
			<if test="po.chooseWay != null">
				and choose_way = #{po.chooseWay}
			</if>
			<if test="po.companyId != null">
				and company_id = #{po.companyId}
			</if>
			<if test="po.grantCount != null">
				and grant_count = #{po.grantCount}
			</if>
			<if test="po.isRepeat != null">
				and is_repeat = #{po.isRepeat}
			</if>
			<if test="po.isDisplay != null">
				and is_display = #{po.isDisplay}
			</if>
			<if test="po.receiveStartTime != null">
				and receive_start_time = #{po.receiveStartTime}
			</if>
			<if test="po.receiveEndTime != null">
				and receive_end_time = #{po.receiveEndTime}
			</if>
			<if test="po.effectStartTime != null">
				and effect_start_time = #{po.effectStartTime}
			</if>
			<if test="po.effectEndTime != null">
				and effect_end_time = #{po.effectEndTime}
			</if>
			<if test="po.effectDays != null">
				and effect_days = #{po.effectDays}
			</if>
			<if test="po.isEffect != null">
				and is_effect = #{po.isEffect}
			</if>
			<if test="po.creator != null">
				and creator = #{po.creator}
			</if>
			<if test="po.createTime != null">
				and create_time = #{po.createTime}
			</if>
			<if test="po.updateTime != null">
				and update_time = #{po.updateTime}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>
			<if test="po.couponBatchName != null">
				and coupon_batch_name = #{po.couponBatchName}
			</if>
		</where>
	</select>

	<select id="findCouponBatchCountByParam" resultType="java.lang.Integer">
		SELECT
		count(1)
		FROM coupon_batch cb left JOIN coupon c ON cb.coupon_rel_id=c.id
		<where>
			<if test="type!=null and type==1">
				AND cb.get_type=3
			</if>
			<if test="platformId != null">
				and cb.platform_id = #{platformId}
			</if>
			<if test="title != null and title !=''">
				and c.title LIKE "%"#{title}"%"
			</if>
			<if test="couponBatchCode != null and couponBatchCode!=''">
				and cb.coupon_batch_code LIKE "%"#{couponBatchCode}"%"
			</if>
			<if test="couponBatchName != null and couponBatchName!=''">
				and cb.coupon_batch_name LIKE "%"#{couponBatchName}"%"
			</if>
			<if test="batchIdList!=null">
				AND cb.id IN
				<foreach  collection="batchIdList"  item="batchId"  open="("  separator=","   close=")">
					#{batchId}
				</foreach>
			</if>
		</where>
	</select>

	<select id="findCouponBatchByParam" resultMap="couponBatchConditionMap">
		SELECT
		cb.id,
		cb.coupon_batch_code,
		cb.coupon_batch_name,
		c.title,
		cb.get_type,
		c.coupon_type,
		c.detail,
		c.discount_amount,
		c.trigger_amount,
		cb.is_display,
		cb.receive_start_time,
		cb.receive_end_time,
		cb.effect_days,
		cb.effect_start_time,
		cb.effect_end_time,
		cb.is_repeat
		FROM coupon_batch cb left JOIN coupon c ON cb.coupon_rel_id=c.id
		<where>
			<if test="type!=null and type==1">
				AND cb.get_type=3
			</if>
			<if test="platformId != null">
				and cb.platform_id = #{platformId}
			</if>
			<if test="title != null and title !=''">
				and c.title LIKE "%"#{title}"%"
			</if>
			<if test="couponBatchCode != null and couponBatchCode!=''">
				and cb.coupon_batch_code LIKE "%"#{couponBatchCode}"%"
			</if>
			<if test="couponBatchName != null and couponBatchName!=''">
				and cb.coupon_batch_name LIKE "%"#{couponBatchName}"%"
			</if>
			<if test="batchIdList!=null">
				AND cb.id IN
				<foreach  collection="batchIdList"  item="batchId"  open="("  separator=","   close=")">
					#{batchId}
				</foreach>
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY cb.id desc
			</otherwise>
		</choose>
		<if test="page != null">
			limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>
	<select id="findCouponBatchByExchange" resultMap="couponBatchConditionMap">
		select
		cb.id,
		cb.coupon_batch_code,
		coupon_batch_name,
		cb.coupon_rel_type,
		cb.coupon_rel_id,
		cb.grant_type,
		cb.get_type,
		cb.choose_way,
		cb.company_id,
		cb.grant_count,
		cb.is_repeat,
		cb.is_display,
		cb.receive_start_time,
		cb.receive_end_time,
		cb.effect_start_time,
		cb.effect_end_time,
		cb.effect_days,
		cb.is_effect,
		cb.creator,
		cb.create_time,
		cb.update_time,
		cb.platform_id,
		cb.coupon_rel_id coupon_id,
		c.title,
		c.detail
		from (exchange_batch eb LEFT JOIN coupon_batch cb ON eb.batch_id=cb.id) LEFT JOIN coupon c ON cb.coupon_rel_id=c.id
		WHERE
		eb.type=1
		AND
		eb.exchange_id=#{exchangeId}
		  ORDER BY eb.sort
	</select>
</mapper>
	