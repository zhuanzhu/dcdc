<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.egeo.components.config.dao.read.LogReadDAO">
	<resultMap type="com.egeo.components.config.po.LogPO" id="logMap">
		<result property="id" column="id" />
		<result property="msgId" column="msg_id" />
		<result property="msgContent" column="msg_content" />
		<result property="operatorName" column="operator_name" />
		<result property="operatorId" column="operator_id" />
		<result property="operObject" column="oper_object" />
		<result property="moduleName" column="module_name" />
		<result property="time" column="time" />
		<result property="ip" column="ip" />
		<result property="clientType" column="client_type" />
		<result property="mobileVersion" column="mobile_version" />
		<result property="operatorObjId" column="operator_obj_id" />
		<result property="operatorObjName" column="operator_obj_name" />
		<result property="operatorObjCode" column="operator_obj_code" />
		<result property="type" column="type" />
		<result property="platformId" column="platform_id" />		
	</resultMap>

	<resultMap type="com.egeo.components.config.condition.LogCondition" id="logConditionMap" extends="logMap">
		<result property="oper" column="oper" />
		<result property="operType" column="operType" />
		<result property="pageName" column="pageName" />
		<result property="module" column="module" />
	</resultMap>

	<sql id="logColumns">
		id,
		msg_id,
		msg_content,
		operator_name,
		operator_id,
		oper_object,
		module_name,
		time,
		ip,
		client_type,
		mobile_version,
		operator_obj_id,
		operator_obj_name,
		operator_obj_code,
		type,
		platform_id
	</sql>

	<select id="findById" parameterType="com.egeo.components.config.po.LogPO" resultMap="logMap">
		SELECT
		<include refid="logColumns" />
		FROM log
		WHERE id = #{po.id}
	</select>

	<select id="findOfPage" resultMap="logMap">
		SELECT
		<include refid="logColumns" />
		FROM log
		<where>
			<if test="po.msgId != null">
				and msg_id = #{po.msgId}
			</if>
			<if test="po.msgContent != null">
				and msg_content = #{po.msgContent}
			</if>
			<if test="po.operatorName != null">
				and operator_name = #{po.operatorName}
			</if>
			<if test="po.operatorId != null">
				and operator_id = #{po.operatorId}
			</if>
			<if test="po.operObject != null">
				and oper_object = #{po.operObject}
			</if>
			<if test="po.moduleName != null">
				and module_name = #{po.moduleName}
			</if>
			<if test="po.time != null">
				and time = #{po.time}
			</if>
			<if test="po.ip != null">
				and ip = #{po.ip}
			</if>
			<if test="po.clientType != null">
				and client_type = #{po.clientType}
			</if>
			<if test="po.mobileVersion != null">
				and mobile_version = #{po.mobileVersion}
			</if>
			<if test="po.operatorObjId != null">
				and operator_obj_id = #{po.operatorObjId}
			</if>
			<if test="po.operatorObjName != null">
				and operator_obj_name = #{po.operatorObjName}
			</if>
			<if test="po.operatorObjCode != null">
				and operator_obj_code = #{po.operatorObjCode}
			</if>
			<if test="po.type != null">
				and type = #{po.type}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>			
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>		
			<otherwise>
				ORDER BY id desc		
			</otherwise>
		</choose>
		<if test="page != null">
		limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>
	
	<select id="countOfPage" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		FROM log
		<where>
			<if test="po.msgId != null">
				and msg_id = #{po.msgId}
			</if>
			<if test="po.msgContent != null">
				and msg_content = #{po.msgContent}
			</if>
			<if test="po.operatorName != null">
				and operator_name = #{po.operatorName}
			</if>
			<if test="po.operatorId != null">
				and operator_id = #{po.operatorId}
			</if>
			<if test="po.operObject != null">
				and oper_object = #{po.operObject}
			</if>
			<if test="po.moduleName != null">
				and module_name = #{po.moduleName}
			</if>
			<if test="po.time != null">
				and time = #{po.time}
			</if>
			<if test="po.ip != null">
				and ip = #{po.ip}
			</if>
			<if test="po.clientType != null">
				and client_type = #{po.clientType}
			</if>
			<if test="po.mobileVersion != null">
				and mobile_version = #{po.mobileVersion}
			</if>
			<if test="po.operatorObjId != null">
				and operator_obj_id = #{po.operatorObjId}
			</if>
			<if test="po.operatorObjName != null">
				and operator_obj_name = #{po.operatorObjName}
			</if>
			<if test="po.operatorObjCode != null">
				and operator_obj_code = #{po.operatorObjCode}
			</if>
			<if test="po.type != null">
				and type = #{po.type}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>			
		</where>
	</select>
	
	<sql id="LogInfoOfPage">
		 FROM log l 
		 LEFT JOIN log_dict ld on ld.id = l.msg_id 
		 LEFT JOIN log_dict ld2 on ld2.id = ld.parent_id 
		 LEFT JOIN log_dict ld3 on ld3.id = ld2.parent_id 
		 LEFT JOIN log_oper_code loc on loc.id = ld.oper_code_id 
			<where>
				<if test="po.msgId != null">
					and l.msg_id = #{po.msgId}
				</if>
				<if test="po.operatorId != null">
					and l.operator_id = #{po.operatorId}
				</if>
				<if test="po.startTime != null">
					and l.time &gt;= #{po.startTime} 
				</if>
				<if test="po.endTime != null">
					and l.time &lt;= #{po.endTime}  
				</if>
				<if test="po.operatorObjId != null">
					and l.operator_obj_id = #{po.operatorObjId}
				</if>
				<if test="po.type != null">
					and l.type = #{po.type}
				</if>
				<if test="po.operatorObjCode != null">
					and (l.operator_obj_code like concat('%',#{po.operatorObjCode},'%') or l.operator_obj_name like concat('%',#{po.operatorObjCode},'%'))
				</if>
				<if test="po.operType != null">
					and ld.operatorType = #{po.operType} 
				</if>
				<if test="po.pageNameId != null">
					and ld2.id = #{po.pageNameId} 
				</if>
				<if test="po.moduleId != null">
					and ld3.id = #{po.moduleId} 
				</if>
				<if test="po.platformId != null">
				and l.platform_id = #{po.platformId}
			</if>	
			</where>
	</sql>
	
	<select id="countLogInfoOfPage" resultType="java.lang.Integer">
		SELECT
		count(1) cnt
		<include refid="LogInfoOfPage"/>
	</select>
	
	<select id="findLogInfoOfPage" resultMap="logConditionMap">
		SELECT
		 l.*, 
		 ld.`name` oper,
		 ld.operatorType operType,
		 ld2.`name` pageName,
		 ld3.`name` module 
		<include refid="LogInfoOfPage"/>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>		
			<otherwise>
				ORDER BY l.id desc		
			</otherwise>
		</choose>
		<if test="page != null">
		limit #{page.limitStart},#{page.pageSize}
		</if>
	</select>
	
	<select id="findAll" resultMap="logMap">
		SELECT
		<include refid="logColumns" />
		FROM log
		<where>
			<if test="po.msgId != null">
				and msg_id = #{po.msgId}
			</if>
			<if test="po.msgContent != null">
				and msg_content = #{po.msgContent}
			</if>
			<if test="po.operatorName != null">
				and operator_name = #{po.operatorName}
			</if>
			<if test="po.operatorId != null">
				and operator_id = #{po.operatorId}
			</if>
			<if test="po.operObject != null">
				and oper_object = #{po.operObject}
			</if>
			<if test="po.moduleName != null">
				and module_name = #{po.moduleName}
			</if>
			<if test="po.time != null">
				and time = #{po.time}
			</if>
			<if test="po.ip != null">
				and ip = #{po.ip}
			</if>
			<if test="po.clientType != null">
				and client_type = #{po.clientType}
			</if>
			<if test="po.mobileVersion != null">
				and mobile_version = #{po.mobileVersion}
			</if>
			<if test="po.operatorObjId != null">
				and operator_obj_id = #{po.operatorObjId}
			</if>
			<if test="po.operatorObjName != null">
				and operator_obj_name = #{po.operatorObjName}
			</if>
			<if test="po.operatorObjCode != null">
				and operator_obj_code = #{po.operatorObjCode}
			</if>
			<if test="po.type != null">
				and type = #{po.type}
			</if>
			<if test="po.platformId != null">
				and platform_id = #{po.platformId}
			</if>			
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>			
			<otherwise>
				ORDER BY id desc		
			</otherwise>
		</choose>
	</select>
</mapper>
	